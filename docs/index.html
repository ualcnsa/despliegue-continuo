<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="keywords" content="CI/CD Jenkins Pipelines NodeJs Docker KeystoneJs">
<title>Despliegue continuo con Jenkins</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Despliegue continuo con Jenkins</h1>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#_prerrequisitos">1. Prerrequisitos</a>
<ul class="sectlevel2">
<li><a href="#_entorno_de_desarrollo">1.1. Entorno de desarrollo</a></li>
<li><a href="#_cupones_educativos_google_cloud">1.2. Cupones educativos Google Cloud</a></li>
<li><a href="#_terraform">1.3. Terraform</a></li>
<li><a href="#_gcloud_cli_para_gcp">1.4. GCloud CLI para GCP</a></li>
<li><a href="#_github_student_education_pack">1.5. Github Student Education Pack</a></li>
</ul>
</li>
<li><a href="#_creación_de_la_infraestructura_en_google_cloud">Creación de la infraestructura en Google Cloud</a>
<ul class="sectlevel1">
<li><a href="#_estructura_del_proyecto_terraform">2. Estructura del proyecto terraform</a></li>
<li><a href="#_creación_de_la_clave_para_la_cuenta_de_servicio">3. Creación de la clave para la Cuenta de servicio</a></li>
<li><a href="#_ejecución_de_terraform">4. Ejecución de terraform</a>
<ul class="sectlevel2">
<li><a href="#_terraform_init">4.1. <code>terraform init</code></a></li>
<li><a href="#_terraform_plan">4.2. <code>terraform plan</code></a></li>
<li><a href="#_terraform_apply">4.3. <code>terraform apply</code></a></li>
<li><a href="#_terraform_destroy">4.4. <code>terraform destroy</code></a></li>
<li><a href="#_más_comandos_útiles">4.5. Más comandos útiles</a></li>
</ul>
</li>
<li><a href="#_cloud_dns">5. Cloud DNS</a>
<ul class="sectlevel2">
<li><a href="#_alta_de_nombre_de_dominio">5.1. Alta de nombre de dominio</a></li>
<li><a href="#_configuración_de_nombres_de_dominio">5.2. Configuración de nombres de dominio</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_primeros_pasos_con_jenkins">Primeros pasos con Jenkins <span class="image"><img src="modules/jenkinsdocker/images/jenkins_ci.png" alt="Jenkins" width="16" height="16"></span></a>
<ul class="sectlevel1">
<li><a href="#_instalación_y_configuración_de_jenkins">6. Instalación y configuración de Jenkins</a>
<ul class="sectlevel2">
<li><a href="#_construcción_del_contenedor_jenkins">6.1. Construcción del contenedor Jenkins</a></li>
<li><a href="#_publicación_en_google_container_registry">6.2. Publicación en Google Container Registry</a></li>
<li><a href="#_ejecución_del_contenedor_de_jenkins">6.3. Ejecución del contenedor de Jenkins</a></li>
<li><a href="#_configuración_básica_de_jenkins">6.4. Configuración básica de Jenkins</a></li>
<li><a href="#_instalación_de_plugins_adicionales">6.5. Instalación de plugins adicionales</a></li>
<li><a href="#_configuración_las_tools_en_jenkins">6.6. Configuración las Tools en Jenkins</a></li>
</ul>
</li>
<li><a href="#_primeros_ejemplos">7. Primeros ejemplos</a>
<ul class="sectlevel2">
<li><a href="#_creación_del_primer_proyecto_freestyle">7.1. Creación del primer proyecto freestyle</a></li>
<li><a href="#_creación_del_primer_pipeline">7.2. Creación del primer pipeline</a></li>
<li><a href="#_conexión_con_la_máquina_de_despliegue">7.3. Conexión con la máquina de despliegue</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_aplicación_web_java">Aplicación Web Java</a>
<ul class="sectlevel1">
<li><a href="#_petclinic">8. PetClinic</a>
<ul class="sectlevel2">
<li><a href="#_construcción_y_ejecución_en_local">8.1. Construcción y ejecución en local</a></li>
<li><a href="#_creación_del_pipeline_para_petclinic">8.2. Creación del Pipeline para PetClinic</a></li>
<li><a href="#_informe_de_cobertura_de_código">8.3. Informe de Cobertura de código</a></li>
<li><a href="#_análisis_estático_de_código_checkstyle">8.4. Análisis estático de código: <em>Checkstyle</em></a></li>
<li><a href="#_despliegue_en_la_vm">8.5. Despliegue en la VM</a></li>
</ul>
</li>
<li><a href="#_petclinic_con_docker">9. PetClinic con Docker</a>
<ul class="sectlevel2">
<li><a href="#_creación_del_dockerfile_multi_stage">9.1. Creación del <code>Dockerfile</code> multi-stage</a></li>
<li><a href="#_autenticación_en_artifact_registry">9.2. Autenticación en Artifact Registry</a></li>
<li><a href="#_publicación_y_despliegue_manual">9.3. Publicación y despliegue <em>manual</em></a></li>
<li><a href="#_integración_y_despliegue_continuo">9.4. Integración y despliegue continuo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_aplicación_en_node_js">Aplicación en Node.js</a>
<ul class="sectlevel1">
<li><a href="#_hola_mundo_en_node_js">10. <em>Hola mundo</em> en Node.js</a>
<ul class="sectlevel2">
<li><a href="#_construcción_y_ejecución_en_local_2">10.1. Construcción y ejecución en local</a></li>
<li><a href="#_creación_del_pipeline_en_jenkins">10.2. Creación del pipeline en Jenkins</a></li>
<li><a href="#_webhook_para_construcción_automática">10.3. <strong>Webhook</strong> para construcción automática</a></li>
<li><a href="#_informe_de_cobertura">10.4. Informe de cobertura</a></li>
<li><a href="#_análisis_estático_de_código">10.5. Análisis estático de código</a></li>
<li><a href="#_despliegue_en_la_vm_2">10.6. Despliegue en la VM</a></li>
</ul>
</li>
<li><a href="#_hola_mundo_en_node_js_con_docker">11. <em>Hola mundo</em> en Node.js con Docker</a>
<ul class="sectlevel2">
<li><a href="#_creación_del_dockerfile">11.1. Creación del <code>Dockerfile</code></a></li>
<li><a href="#_publicación_de_la_imagen_en_el_registro">11.2. Publicación de la imagen en el registro</a></li>
<li><a href="#_despliegue_en_vm">11.3. Despliegue en VM</a></li>
<li><a href="#_integración_y_despliegue_continuos_con_jenkins">11.4. Integración y despliegue continuos con Jenkins</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Computación en la Nube, Servicios y Aplicaciones. Joaquín Cañadas &lt;<a href="mailto:jjcanada@ual.es">jjcanada@ual.es</a>&gt;, Francisco García &lt;<a href="mailto:paco.garcia@ual.es">paco.garcia@ual.es</a>&gt;</p>
</div>
<div class="paragraph">
<p><em>Version</em> <strong>0.22.2</strong></p>
</div>
<div class="exampleblock">
<div class="title">Objetivos</div>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Crear una infraestructura de CI/CD en GCP con Máquinas Virtuales gestionadas con Terraform</p>
</li>
<li>
<p>Diseñar proyectos Jenkins <span class="image"><img src="modules/ROOT/images/jenkins_ci.png" alt="Jenkins" width="16" height="16"></span> para la construcción y despliegue automatizado de aplicaciones en Java y NodeJs</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Realización y entrega</div>
<div class="paragraph">
<p>La realización de estas actividades se realizará de forma <strong>individual</strong>. Serán la base para actividades posteriores que ser harán en equipo.
La entrega será mediante el envío de un informe y el acceso al profesor a los servicios configurados por cada estudiante, para la revisión y evaluación de los mismos.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Esta es la versión <strong>0.22.2</strong> de este documento.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerrequisitos">1. Prerrequisitos</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_entorno_de_desarrollo">1.1. Entorno de desarrollo</h3>
<div class="paragraph">
<p>Existen distintas opciones respecto al entorno en el que realizar las actividades propuestas. Tendrás que conectar a las instancias en GCP, lanzar Terraform, lanzar contenedores Docker, etc. Dependiendo del sistema operativo de tu máquina local y de tus gustos personales, te recomiendo alguna las siguientes alternativas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows: es recomendable usar un terminal basado en Linux, por ejemplo <strong>Git Bash</strong> (<a href="https://git-scm.com" class="bare">https://git-scm.com</a>).</p>
</li>
<li>
<p>Linux y Mac: el <strong>terminal del S.O</strong> incluye todas las herramientas básicas necesarias (<em>git</em>, <em>ssh</em>, <em>etc</em>).</p>
</li>
<li>
<p><strong>Cloud Shell de Google Cloud</strong>: la consola web de Google Cloud proporciona la herramienta <strong>Cloud Shell</strong> que permite trabajar cómodamente contra GCP desde cualquier navegador web y cualquier S.O. Recuerda que Cloud Shell tiene una cuota de uso, con un límite de número de horas semanales (168h):</p>
</li>
</ul>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/prerrequisitos/images/cloud-shell-cuota.png" alt="cloud shell cuota">
</div>
<div class="title">Fig. 1. Cuota de Cloud Shell</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para ver tu cuota semanal, haz clic en <span class="image"><img src="modules/prerrequisitos/images/session-info-icon.png" alt="session info icon"></span> <strong>Información de la sesión</strong> y, luego, en <strong>Cuota de uso</strong>. Aparecerá un cuadro de diálogo en el que se mostrarán las horas restantes en tu cuota, la cantidad total de horas en ella y la fecha y hora en que se restablecerá la cuota.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se explican las herramientas que debes configurar si estás usando tu máquina local, aunque probablemente algunas ya las tendrás instaladas. Si optas por trabajar en Cloud Shell, seguramente también estarán ya instaladas.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
En general evita usar el usuario <code>root</code> salvo que sea estrictamente necesario, para no generar problemas de permisos sobre los archivos y carpetas cuando estés usando un usuario distinto de <code>root</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Utiliza <code>sudo</code> delante de los comandos estrictamente cuando requieras permisos de administrador, pero evita hacerlo de forma predeterminada (evita <code>sudo su</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para comenzar a trabajar, será necesario tener instalados en la máquina local las siguientes herramientas: Terraform, Google Cloud CLI. Se presupone que ya se tiene instalado un entorno de desarrollo como Visual Studio Code, y una pareja de claves SSH personal en la carpeta <code>HOME</code> del usuario (<code>~</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>~/.ssh/
├── id_rsa <i class="conum" data-value="1"></i><b>(1)</b>
└── id_rsa.pub <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>clave privada</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>clave pública</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recuerda que <code>~/</code> hace referencia la carpeta HOME del usuario en la máquina local:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En Windows: <code>C:\Users\USUARIO</code></p>
</li>
<li>
<p>En Mac: <code>/Users/USUARIO</code></p>
</li>
<li>
<p>En Linux: <code>/home/USUARIO</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Creación de pareja de claves SSH</div>
<div class="content">
<div class="paragraph">
<p>Si aun no tienes pareja de claves SSH, ejecuta el siguiente comando en tu terminal para crear una nueva pareja de claves SSH, usando el email como etiqueta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ssh-keygen -t rsa -b 4096 -C "your_email@inlumine.ual.es"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando te pregunte <code>Enter a file in which to save the key</code> presiona Enter para aceptar el nombre de archivo predeterminado (<code>id_rsa</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Enter a file in which to save the key (/c/Users/you/.ssh/id_rsa):
[Press enter]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación te pedirá una contraseña o <code>passphrase</code>, de nuevo presiona Enter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Enter passphrase (empty for no passphrase): [Press enter]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Presiona Enter de nuevo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Type passphrase again: [Press enter]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consulta si la pareja de claves se ha creado correctamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ls -al ~/.ssh</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Además, se debe disponer de crédito en GCP, proporcionado por el profesor, y darse de alta en Github Student Education Pack. A continuación se describen en detalle estos requisitos previos.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cupones_educativos_google_cloud">1.2. Cupones educativos Google Cloud</h3>
<div class="paragraph">
<p>Si ya dispones de crédito en GCP, podrás usarlo ahora. En cualquier caso, para esta asignatura disponemos de un nuevo cupón educativo de 50$ por estudiante, que no necesita tarjeta de crédito para su activación. Actívalo en la dirección que encontrarás en el <a href="https://aulavirtual.ual.es/">Aula Virtual</a> de la asignatura, en la sección <strong>Area de Contenido</strong> &gt; <strong>Cupones de GCP</strong>, usando tu email <em>@inlumine.ual.es</em>.</p>
</div>
<div class="paragraph">
<p>Accede a la <a href="https://console.cloud.google.com/">Consola de Google Cloud</a> y <strong>crea un nuevo proyecto</strong> GCP con el nombre <strong>cnsa2024-<em>abc123</em></strong> (indicando el año correcto y sustituyendo <em>abc123</em> por tu nombre de usuario), y dale permisos al profesor. Para ello, revisa las instrucciones que vimos en la asignatura del primer cuatrimestre. El crédito del cada cupón dura 12 meses, así que este nuevo proyecto asígnalo a la cuenta de facturación de la asignatura del primer cuatrimestre, ya que es mejor consumir ese crédito porque caduca antes. Si se consume el crédito del primer cupón, simplemente tendrás que cambiar tu proyecto <strong>cnsa2024-<em>abc123</em></strong> a la nueva cuenta de facturación del nuevo cupón.</p>
</div>
</div>
<div class="sect2">
<h3 id="_terraform">1.3. Terraform</h3>
<div class="paragraph">
<p>Terraform es una aplicación que se distribuye en un único archivo ejecutable. Las instrucciones de instalación de Terraform está disponibles <a href="https://learn.hashicorp.com/terraform/getting-started/install.html">aquí</a>.</p>
</div>
<div class="paragraph">
<p>En Windows se recomienda instalarlo con <a href="https://chocolatey.org/docs/installation">Chocolatey</a>. Así que si previamente has instalado Chocolatey, simplemente abre una ventana de comandos (cmd) con <strong>permiso de administrador</strong> y ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">choco install terraform -y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cierra el terminal o la ventana de comandos, abre una nueva con permisos normales y comprueba que se ha instalado correctamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">terraform -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>La salida debe mostrar la version instalada:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ terraform -v
Terraform v1.1.6
on windows_amd64</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gcloud_cli_para_gcp">1.4. GCloud CLI para GCP</h3>
<div class="paragraph">
<p>Google Cloud Command Line Interface está disponible para su instalación <a href="https://cloud.google.com/sdk/install">aquí</a>.</p>
</div>
<div class="paragraph">
<p>En Windows se recomienda instalarlo con Chocolatey: abre una ventana de comandos (cmd) con <strong>permiso de administrador</strong> y ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">choco install gcloudsdk -y</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_github_student_education_pack">1.5. Github Student Education Pack</h3>
<div class="paragraph">
<p>Para poder usar servicios adicionales, como DNS gratuito, debes darte de alta en <a href="https://education.github.com/pack">Github Student Education Pack</a>.</p>
</div>
<div class="paragraph">
<p>Si ya dispones de una cuenta de GitHub, y no quieres crear una cuenta nueva, simplemente debes añadir tu email <em>@inlumine.ual.es</em> a la lista de emails de tu cuenta actual. Para ello, sigue las <a href="https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/adding-an-email-address-to-your-github-account">instrucciones</a>. Tras añadir tu email, haz clic en el enlace <a href="https://education.github.com/pack">Get the pack</a>.</p>
</div>
</div>
</div>
</div>
<h1 id="_creación_de_la_infraestructura_en_google_cloud" class="sect0">Creación de la infraestructura en Google Cloud</h1>
<div class="openblock partintro">
<div class="content">
<div class="exampleblock">
<div class="title">Objetivos</div>
<div class="content">
<div class="paragraph">
<p>Utilizando una plantilla de terraform crea 2 instancias de máquina virtuales en tu proyecto en Google Cloud:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instancia para instalar Jenkins mediante un contenedor Docker.</p>
</li>
<li>
<p>Instancia de despliegue (VM Deploy) con Docker y Docker Composer instalados.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/terraform-vm-schema.png" alt="terraform vm schema">
</div>
<div class="title">Fig. 2. Máquinas virtuales creadas con Terraform</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_estructura_del_proyecto_terraform">2. Estructura del proyecto terraform</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para crear las instancias, utiliza la plantilla de terraform disponible en el repositorio <a href="https://github.com/ualcnsa/terraformGoogleCloudSample" class="bare">https://github.com/ualcnsa/terraformGoogleCloudSample</a>.
En primer lugar realiza un <em>fork</em> del repositorio, para hacer las modificaciones al mismo que sean necesarias. Después, sobre tu <em>fork</em>, modifica las variables correspondientes para usar tu proyecto en la plantilla, tal y como se describe a continuación.</p>
</div>
<div class="paragraph">
<p>El repositorio consta de tres archivos con extension .tf, y una carpeta con un template para la creación de instancias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>terraformGoogleCloudSample
├── instance
│   └── <strong>main.tf</strong> <i class="conum" data-value="4"></i><b>(4)</b>
├── .gitignore
├── README.md
├── <strong>mynetwork.tf</strong> <i class="conum" data-value="2"></i><b>(2)</b>
├── <strong>output.tf</strong> <i class="conum" data-value="3"></i><b>(3)</b>
└── <strong>provider.tf</strong> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descripción del proveedor sobre el que ejecutar la plantilla, en nuestro caso Google Cloud.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Plantilla principal. Crea la red, las reglas de firewall, las 2 instancias llamando al <em>módulo</em> <code>main.tf</code> de la carpeta <code>instance</code>, y por último realiza la inicialización de cada instancia.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Plantilla con los valores que se muestran de salida al finalizar la ejecución</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Módulo genérico para crear una instancia. Es llamado desde <code>network.tf</code> pasándole las variables que necesita para crear la instancia.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El archivo <code><strong>provider.tf</strong></code> deberás modificarlo:</p>
</div>
<div class="listingblock">
<div class="title">provider.tf</div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf"># Descargar json con credenciales de aquí:
# https://console.cloud.google.com/apis/credentials/serviceaccountkey
# Tras ello definir la variable de entorno apuntando a el json
# export GOOGLE_CLOUD_KEYFILE_JSON=path/file.json

variable "gcp_project" {
  # Configurar el nombre del proyecto en GCP
  default = "cnsa-2024" <i class="conum" data-value="1"></i><b>(1)</b>
}

terraform {
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "5.18.0" <i class="conum" data-value="2"></i><b>(2)</b>
    }
  }
}

provider "google" {
  project = var.gcp_project
  region  = "us-central1"
  zone    = "us-central1-c"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sustituye este valor por el nombre de tu proyecto, indicando el año correcto y concatenando tu nombre de usuario de la UAL (<em>cnsa2024-abc123</em>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Versión del proveedor de Google Cloud que se va a utilizar. Utiliza la última disponible, que puedes consultar en <a href="https://registry.terraform.io/providers/hashicorp/google/latest">aquí</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creación_de_la_clave_para_la_cuenta_de_servicio">3. Creación de la clave para la Cuenta de servicio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para que terraform pueda conectar al <em>provider</em> Google Cloud desde tu máquina local, debes proporcionar clave para la Cuenta de servicio.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Seleccionar el proyecto Google Cloud.</p>
</li>
<li>
<p>En el menú de navegación seleccionar <code>IAM y administración | Cuentas de servicio</code>.</p>
</li>
</ul>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio.png" alt="crear clave cuenta servicio">
</div>
<div class="title">Fig. 3. Creación del archivo de credenciales Google Cloud</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Selecciona el proyecto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Selecciona <em>Crear Cuenta de Servicio</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Da un nombre a la cuenta de servicio (p.e. <code>terraform</code>), y pulsa <em>Crear y Continuar</em></p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio2.png" alt="crear clave cuenta servicio2">
</div>
<div class="title">Fig. 4. Propiedades del archivo de credenciales Google Cloud</div>
</div>
<div class="paragraph">
<p>Selecciona el rol <em>Administrador de Compute Engine</em> (también es suficiente con <code>Proyecto &#8594; Editor</code>), y pulsa <em>Continuar</em></p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio3.png" alt="crear clave cuenta servicio3">
</div>
<div class="title">Fig. 5. Rol de administrador de la cuenta de servicio</div>
</div>
<div class="paragraph">
<p>Deja en blanco los siguiente campos, y pulsa <em>Listo</em>.</p>
</div>
<div class="paragraph">
<p>A continuación, accede a la cuenta de servicio recien creada:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio4.png" alt="crear clave cuenta servicio4">
</div>
<div class="title">Fig. 6. Detalles de la nueva cuenta de servicio</div>
</div>
<div class="paragraph">
<p>Ve a la pestaña <em>Claves</em>, <em>Agregar Claves</em>, <em>Crear nueva Clave</em>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio5.png" alt="crear clave cuenta servicio5">
</div>
<div class="title">Fig. 7. Nueva clave de cuenta de servicio</div>
</div>
<div class="paragraph">
<p>Dejar <code>JSON</code> en el tipo de clave.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio6.png" alt="crear clave cuenta servicio6">
</div>
<div class="title">Fig. 8. Nueva clave de cuenta de servicio JSON</div>
</div>
<div class="paragraph">
<p>Seleccionar <code>Crear</code>. A continuación se descargará la clave privada.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/crear-clave-cuenta-servicio7.png" alt="crear clave cuenta servicio7">
</div>
<div class="title">Fig. 9. Nueva clave descargada</div>
</div>
<div class="paragraph">
<p>Guarda el archivo .json en la carpeta <code>credentials</code> del proyecto terraform. A continuación, en tu terminal define la variable de entorno apuntando a el archivo recién descargado, sustituyendo <code>path/file.json</code> por la ruta relativa y el nombre del archivo de credenciales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export GOOGLE_CLOUD_KEYFILE_JSON=<strong>path/file.json</strong></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recuerda: <strong>NUNCA subas tu archivo de credenciales json</strong> a un repositorio público como GitHub. Para evitarlo, añade el nombre el archivo de credenciales al <strong><code>.gitignore</code></strong>. Se recomienda guardar el archivo <code>.json</code> en una carpeta llamada <code>credentials</code>, porque ya estaría ignorado, puedes verlo en el <strong><code>.gitignore</code></strong> del repositorio que has forkeado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En el archivo de credenciales va tu <strong>clave privada</strong> que sustituye a tu usuario y contraseña para crear recursos en GCP. Hay <strong>robots</strong> que continuamente analizan repositorios públicos de  GitHub buscando PRIVATE KEYS y API TOKENS. Si un <em>hacker</em> accede a ese archivo, lo usará para crear servicios hasta agotar tu crédito por completo, fundamentalmente para <strong>minar bitcoins</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ejecución_de_terraform">4. Ejecución de terraform</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Videotutorial</div>
<div class="paragraph">
<p>Accede al <a href="https://drive.google.com/file/d/1_ku2LnVbMmWgns-s8_23ATAQ3nrQEJo2/view?usp=sharing" target="_blank" rel="noopener">videotutorial</a> explicativo de esta sección (mp4, 20 minutos, 171M).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_init">4.1. <code>terraform init</code></h3>
<div class="paragraph">
<p>Una vez configurado el <em>provider</em> comprueba que la conexión es correcta: en tu terminal, ejecuta el comando <code>terraform init</code> para inicializar el proyecto como un proyecto terraform. Si todo es correcto aparecerá un mensaje de éxito.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/terraform-init-ok.png" alt="terraform init ok">
</div>
<div class="title">Fig. 10. <code>terraform init</code> correcto</div>
</div>
<div class="paragraph">
<p>Si por el contrario recibes algún mensaje de error, revisa el motivo del error:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Terraform puede que no esté accesible. Debería estar en el <code>PATH</code></p>
</li>
<li>
<p>Revisa si la variable de entorno si se ha guardado correctamente, ejecuta <code>echo $GOOGLE_CLOUD_KEYFILE_JSON</code> y comprueba que es la ruta y nombre de archivo correctos.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_plan">4.2. <code>terraform plan</code></h3>
<div class="paragraph">
<p>Ejecuta el comando <code>terraform plan</code> para ver el resultado de elementos que se crearán o eliminarán al ejecutar la plantilla. Debe aparecer que se crearán 7 elementos.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/terraform-plan-ok.png" alt="terraform plan ok">
</div>
<div class="title">Fig. 11. <code>terraform plan</code> correcto</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_apply">4.3. <code>terraform apply</code></h3>
<div class="paragraph">
<p>Ejecuta el comando <code>terraform apply --auto-approve</code> para ejecutar la plantilla. Comenzará a crear los 7 elementos definidos en la plantilla. Tardará unos <strong>5 minutos</strong> o incluso más, así que ten paciencia. Sobre todo tardará en ejecutar los bloques de inicialización de las instancias, en las que se actualizan los paquetes, se instala Docker y otros paquetes. En todo momento verás en pantalla el <code>log</code> de las operaciones que se están realizando.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si la primera vez que aplicas el plan aparece un mensaje de <span class="red">Error:</span> <code>&#8230;&#8203; Error 403: Compute Engine API has not been used in project&#8230;&#8203;</code> es debido a que aun no se ha  activado la API de Compute Engine  en el proyecto. Haz clic en el enlace del error y activa la API. Espera un par de minutos y vuelve a lanzar terraform.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/habilitar-ComputeEngineAPI.png" alt="habilitar ComputeEngineAPI">
</div>
<div class="title">Fig. 12. Habilitar la API de Compute Engine</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras la ejecución, comprueba que las instancias se han creado correctamente en tu proyecto Google Cloud.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Apaga las instancias</strong> cuando dejes de usarlas, para evitar que consuman crédito.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_destroy">4.4. <code>terraform destroy</code></h3>
<div class="paragraph">
<p>Cuando desees eliminar todos los recursos que hemos creado con esta plantilla, simplemente ejecuta <code>terraform destroy</code>. Por ahora debes simplemente apagar las instancias cuando no las uses, porque las necesitaremos en el resto de la asignatura.</p>
</div>
</div>
<div class="sect2">
<h3 id="_más_comandos_útiles">4.5. Más comandos útiles</h3>
<div class="paragraph">
<p><code>terraform state list</code>: Muestra todos los recursos que gestiona terraform.</p>
</div>
<div class="paragraph">
<p><code>terraform state show &lt;recurso&gt;</code>: Muestra los detalles de un recurso concreto.</p>
</div>
<div class="paragraph">
<p><code>terraform show</code>: Muestra los detalles de todos los recursos.</p>
</div>
<div class="paragraph">
<p>Si necesitas destruir y volver a crear un recurso concreto, y no todo el plan:</p>
</div>
<div class="paragraph">
<p><code>terraform plan -destroy -target=&lt;recurso&gt;</code>: Muestra el plan de destrucción de un recurso concreto.</p>
</div>
<div class="paragraph">
<p>terraform destroy -target=&lt;recurso&gt; --auto-approve: Destruye un recurso concreto.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cloud_dns">5. Cloud DNS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Cloud ha asignado una IP pública estática a cada una de tus instancias (la IP no cambiará al apagar la instancia y volver a encenderla). A continuación, vamos a asignar nombres de DNS a esas IPs con Cloud DNS y uno de los servicios de DNS disponibles en el Student Pack de GitHub.</p>
</div>
<div class="sect2">
<h3 id="_alta_de_nombre_de_dominio">5.1. Alta de nombre de dominio</h3>
<div class="paragraph">
<p>GitHub Student pack ofrece varios servicios de nombres dominios gratuitos durante 1 año. Puedes usar <em>name.com</em>, <em>namecheap</em>, o <em>.tech domains</em>. En uno de ellos vamos a dar de alta un nombre de dominio para nuestras instancias en Google Cloud. Voy a describir cómo hacerlo con <strong>.tech</strong>.</p>
</div>
<div class="paragraph">
<p>Accede a <a href="https://get.tech/github-student-developer-pack">get.tech</a> y prueba un nombre de dominio que te guste y que esté disponible. Cuando encuentres el adecuado, añadeló al carrito con la opción <em>Buy for 1 year</em> seleccionada.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/tech-domain-disponible.png" alt="tech domain disponible">
</div>
<div class="title">Fig. 13. Comprobar si el dominio está disponible en get.tech</div>
</div>
<div class="paragraph">
<p>A continuación, inicia sesión con tu cuenta de github, y verás que tienes el descuento por un año. Procede a la compra gratuita. Además, tendrás que registrarte para poder acceder posteriormente a la configuración. Debes completar los datos de registro ya que te identifican como propietario del nombre de dominio. Si lo deseas, usa como dirección <em>Universidad de Almería, Ctra. Sacramento s/n, 04120, Almería, Spain</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_nombres_de_dominio">5.2. Configuración de nombres de dominio</h3>
<div class="paragraph">
<p>Para configurar el nombre de dominio que acabas de adquirir a las IPs reservadas, debes usar Cloud DNS en Google Cloud. Cloud DNS permite asignar los nombres de dominio a las direcciones IP públicas de las instancias. Recuerda comprobar que las IPs son estáticas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En el menú de la consola de Google Cloud, entra en <strong>Servicios de red</strong>, <strong>Cloud DNS</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/cloud-dns.png" alt="cloud dns" width="360">
</div>
<div class="title">Fig. 14. Cloud DNS</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Haz clic en <strong>Crear Zona</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/cloud-dns-crear-zona.png" alt="cloud dns crear zona">
</div>
<div class="title">Fig. 15. Cloud DNS, crear zona</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>A continuación, haz clic en <strong>Añadir Conjunto de registros</strong>. Para cada instancia, crea un conjunto de registros.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/cloud-dns-crear-conjunto-de-registros.png" alt="cloud dns crear conjunto de registros">
</div>
<div class="title">Fig. 16. Cloud DNS. Crear conjunto de registros, instancia Jenkins</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/cloud-dns-crear-conjunto-de-registros2.png" alt="cloud dns crear conjunto de registros2">
</div>
<div class="title">Fig. 17. Cloud DNS. Crear conjunto de registros, instancia de despliegue de apps</div>
</div>
<div class="paragraph">
<p>Tras la creación, debes tener un resultado similar a este:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/cloud-dns-detalles-zona.png" alt="cloud dns detalles zona">
</div>
<div class="title">Fig. 18. Cloud DNS. Detalles de la Zona</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>El último paso será modificar los servidores de DNS de la configuración en la web .tech, para poner los valores de los servidores de Google Cloud. Para ello, inicia sesión en get.tech. Entra en tu pedido.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/get-tech-manage-orders.png" alt="get tech manage orders">
</div>
<div class="title">Fig. 19. get.tech. Acceso al pedido</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Modifica los nombres de los servidores con los valores de tu zona en Cloud DNS</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/infraestructura/images/get-tech-manage-servers.png" alt="get tech manage servers">
</div>
<div class="title">Fig. 20. get.tech. Nombres de los servidores</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Guarda los cambios. Hasta <strong>pasadas 24 horas</strong> no estarán disponibles.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<h1 id="_primeros_pasos_con_jenkins" class="sect0">Primeros pasos con Jenkins <span class="image"><img src="modules/jenkinsdocker/images/jenkins_ci.png" alt="Jenkins" width="16" height="16"></span></h1>
<div class="openblock partintro">
<div class="content">
<div class="exampleblock">
<div class="title">Objetivos</div>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Vamos a usar la primera instancia para instalar Jenkins. En lugar de realizar una <a href="https://ualhmis.github.io/Jenkins2Instalacion/">instalación completa sobre el sistema operativo</a>, utilizando los paquetes de Ubuntu, tal como se hace en la asignatura Herramientas y Métodos de Ingeniería del Software, de 3º del Grado en Ingeniería Informática, aquí vas a desplegar Jenkins como un contenedor de Docker.</p>
</li>
<li>
<p>Después, crearemos los primeros ejemplos de proyectos en jenkins, tanto un <em>proyecto libre</em> como un proyecto de tipo <em>pipeline</em>. Además, realizaremos la configuración para poder conectar con la instancia de despliegue que nos permitirá automatizar el despliegue sobre ella.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instalación_y_configuración_de_jenkins">6. Instalación y configuración de Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A continuación se describe cómo desplegar Jenkins como un contenedor de Docker.</p>
</div>
<div class="sect2">
<h3 id="_construcción_del_contenedor_jenkins">6.1. Construcción del contenedor Jenkins</h3>
<div class="paragraph">
<p>La imagen pública del contenedor de Jenkins está disponible en <a href="https://hub.docker.com/r/jenkins/jenkins">DockerHub</a>, con el nombre <code>jenkins/jenkins:lts</code>. Esta imagen genérica necesita instalarle algunos plugins y herramientas. En concreto, hay que instalarle el propio Docker para permitir que Jenkins ejecute tareas de docker, como por ejemplo <code>docker build</code> para construir imágenes de contenedores. Esto es lo que se conoce como <a href="https://devopscube.com/run-docker-in-docker/">Docker-in-Docker (dind)</a>, y hay que <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">gestionarlo correctamente cuando se trata de entornos de CI</a>.</p>
</div>
<div class="paragraph">
<p>Por tanto, vamos a crear una imagen personalizada del contenedor de Jenkins basándonos en la imagen pública e instalándo Docker dentro del contenedor.
Lo más adecuado es que construyas la imagen de Jenkins con Docker en la propia máquina donde lo vamos a ejecutar, es decir en la instancia de jenkins.</p>
</div>
<div class="paragraph">
<p>Conecta por ssh a la instancia de jenkins. Recuerda que el usuario de la instancia es <code>ubuntu</code>. Por tanto, la conexión a la misma  consistiría en ejecutar desde el terminal el comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>ssh ubuntu@MAQUINA_JENKINS</code></pre>
</div>
</div>
<div class="paragraph">
<p>sustituyendo MAQUINA_JENKINS por la IP o el nombre DNS de la misma.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si utilizas la shell de la consola web de Google Cloud para conectar por ssh a la máquina, verás que estarás conectado como tu usuario de la UAL, del tipo <code>abc123</code>. En este caso RECUERDA sustituir <code>ubuntu</code> por tu usuario <code>abc123</code> en todos los comandos y ejemplos de este documento.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Realiza las actividades conectando a las instancias bien con el usuario <code>ubuntu</code> de la máquina, o bien si usas la shell de la consola web de Google Cloud, con tu usuario de la UAL (del tipo <code>abc123</code>). <strong>Se consistente</strong>, es decir, hazlo siempre con el mismo usuario. Se <strong>DESACONSEJA</strong> ejecutar los comandos como <code>root</code> mediante <code>sudo su</code>. Solamente en caso de que sea absolutamente necesario, ejecuta los comandos con <code>sudo</code> delante para tener permisos de <code>root</code> puntualmente. Si haces las actividades como <code>root</code>, tendrás problemas de permisos de acceso los archivos y carpetas, como por ejemplo a las claves SSH.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Prueba que docker se ejecuta correctamente. Si la ejecución de <code>docker ps -a</code> te da error, prueba a ejecutarlo con <code>sudo</code>. Para evitar tener que escribir siempre <code>sudo</code> delante de cualquier comando docker`, ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo usermod -aG docker $USER</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ello, reinicia la sesión. Prueba ahora sin <code>sudo</code>, a partir de ahora llama siempre a docker sin <code>sudo</code>. Más info <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">aquí</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Crea una carpeta <code>jenkins-docker</code> y crea el archivo <code>Dockerfile</code>. Usa el siguiente Dockerfile (descrito en esta entrada de <em>medium.com</em>:  <a href="https://medium.com/@gustavo.guss/jenkins-building-docker-image-and-sending-to-registry-64b84ea45ee9">Jenkins Building Docker Image and Sending to Registry</a>.</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM jenkins/jenkins:lts

USER root

RUN apt-get update &amp;&amp; \
apt-get -y install apt-transport-https \
    ca-certificates \
    curl \
    gnupg2 \
    software-properties-common &amp;&amp; \
curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg &gt; /tmp/dkey; apt-key add /tmp/dkey &amp;&amp; \
add-apt-repository \
    "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \
    $(lsb_release -cs) \
    stable" &amp;&amp; \
  apt-get update &amp;&amp; \
  apt-get -y install docker-ce

RUN apt-get install -y docker-ce

RUN usermod -a -G docker jenkins

USER jenkins</code></pre>
</div>
</div>
<div class="paragraph">
<p>Construimos la imagen a partir del Dockerfile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker build --tag <strong>ualjjcanada</strong>/jenkins-docker:1.0 . <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sustituye <strong>ualjjcanada/</strong> por tu usuario de Dockerhub si estás registrado, si no simplemente no lo pongas.</td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/docker-build-tag.png" alt="docker build tag">
</div>
<div class="title">Fig. 21. <code>docker build</code> de Jenkins con Docker</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/docker-build-tag-successfully.png" alt="docker build tag successfully">
</div>
<div class="title">Fig. 22. <code>docker build</code> successful</div>
</div>
<div class="paragraph">
<p>Comprueba que la imagen ha sido creada, y está disponible en tu máquina:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>docker image ls</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/docker-image-ls.png" alt="docker image ls">
</div>
<div class="title">Fig. 23. <code>docker image ls</code></div>
</div>
</div>
<div class="sect2">
<h3 id="_publicación_en_google_container_registry">6.2. Publicación en Google Container Registry</h3>
<div class="paragraph">
<p>Opcionalmente podemos publicar nuestra imagen personalizada en DockerHub, o alternativamente el Google Container Registry. Más adelante se describirá cómo hacerlo.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ejecución_del_contenedor_de_jenkins">6.3. Ejecución del contenedor de Jenkins</h3>
<div class="paragraph">
<p>Ejecutamos el contenedor a partir de la imagen creada previamente.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una carpeta para <code>jenkins_home</code> que configuraremos como volumen para que los datos de Jenkins se guarden fuera del contenedor.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir ~/jenkins_home
chmod 777 ~/jenkins_home</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Ejecutamos el contenedor con <code>docker run</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -d --name jenkins-docker -p 80:8080 -p 50000:50000 -v /var/run/docker.sock:/var/run/docker.sock -v ~/jenkins_home:/var/jenkins_home --restart always ualjjcanada/jenkins-docker:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los parámetros de <code>docker run</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--name jenkins-docker</code>: nombre que le asignamos al contenedor</p>
</li>
<li>
<p><code>-p 80:8080</code>: jenkins se ejecutará en el puerto 80 en el host, que está mapeado al puerto 8080 del contenedor</p>
</li>
<li>
<p><code>-v /var/run/docker.sock:/var/run/docker.sock</code>: volumen para compartir el docker socket (usado en la máquina host) con el contenedor.</p>
</li>
<li>
<p><code>-v ~/jenkins_home:/var/jenkins_home</code>: mapea la carpeta local <code>~/jenkins_home</code> con la carpeta <code>/var/jenkins_home</code> del contenedor. En el contenedor, la carpeta HOME del usuario <em>jenkins</em> es <code>/var/jenkins_home</code>, donde Jenkins guarda todos los archivos que utiliza. Si se tira el contenedor o se actualiza, no se pierden los datos ya que se guardan "fuera" del contenedor.</p>
</li>
<li>
<p><code>--restart always</code>: inicia el contenedor cuando se enciende la instancia.</p>
</li>
<li>
<p><code>ualjjcanada/jenkins-docker:1.0</code>: imagen del contenedor a ejecutar, la que hemos construido en el paso anterior.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Comprueba que el contenedor está ejecutándose con <code>docker ps</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/docker-ps-jenkins.png" alt="docker ps jenkins">
</div>
<div class="title">Fig. 24. <code>docker ps</code></div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_básica_de_jenkins">6.4. Configuración básica de Jenkins</h3>
<div class="paragraph">
<p>A continuación se muestran los pasos a realizar en el inicio y configuración básica de Jenkins. Además, se describe la instalación de algunos plugins adicionales.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conectamos a la IP/URL de la instancia con el navegador web. Aparecerá la ventana para introducir el password inicial. Para ver el password ejecuta:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat /home/ubuntu/jenkins_home/secrets/initialAdminPassword</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-unlock.png" alt="jenkins unlock">
</div>
<div class="title">Fig. 25. Contraseña inicial de Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Selecciona Install suggested plugins.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-install-suggested-plugins.png" alt="jenkins install suggested plugins">
</div>
<div class="title">Fig. 26. Install suggested plugins</div>
</div>
<div class="paragraph">
<p>Tras unos minutos, introduce los datos del  usuario administrador de Jenkins. Introduce un nombre de usuario y contraseña.</p>
</div>
<div class="paragraph">
<p>Acepta el nombre de dominio de la máquina. Si aun no has registrado el nombre de dominio, lo puedes hacer más tarde en la configuración general de Jenkins.</p>
</div>
<div class="paragraph">
<p>Jenkins está listo.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-welcome.png" alt="jenkins welcome">
</div>
<div class="title">Fig. 27. Bienvenida a Jenkins</div>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_plugins_adicionales">6.5. Instalación de plugins adicionales</h3>
<div class="paragraph">
<p>Vamos a instalar varios plugins: NodeJs, GitHub integration, Docker Pipeline, Warnings (Next Generation), JaCoCo, Coverage, <a href="https://plugins.jenkins.io/google-container-registry-auth">Google Container Registry Auth</a>.</p>
</div>
<div class="paragraph">
<p>Haz clic en <em>Manage Jenkins</em> &gt; <em>Manage Plugins</em>. En la pestaña <em>Available</em> busca <em>Github integration</em>, seleccionalo y pulsa en <em>Download now and install after restart</em>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-plugins-github-integration.png" alt="jenkins plugins github integration">
</div>
<div class="title">Fig. 28. Instalación del plugin Github integration</div>
</div>
<div class="paragraph">
<p>Repite los pasos para los plugins el resto de plugins.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-plugins-nodejs.png" alt="jenkins plugins nodejs">
</div>
<div class="title">Fig. 29. Instalación del plugin NodeJS</div>
</div>
<div class="paragraph">
<p>Marca <em>Restart Jenkins</em> para completar la instalación. Tras unos segundos, vuelve a iniciar sesión y tendrás los plugins instalados.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-plugins-restart.png" alt="jenkins plugins restart">
</div>
<div class="title">Fig. 30. Reiniciar para completar la instalación</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_las_tools_en_jenkins">6.6. Configuración las Tools en Jenkins</h3>
<div class="paragraph">
<p>Tras la instalación del plugin <a href="https://plugins.jenkins.io/nodejs/"><em>NodeJS</em></a>, es necesario realizar la siguiente configuración:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ve a <em>Manage Jenkins</em>, <em>Global Tool configuration</em>.</p>
</li>
<li>
<p>En <strong>NodeJS</strong>, añade un instalador (se recomienda la última versión <em>lts</em> disponible). Dale por nombre "nodejs lts" y marca instalar automáticamente.</p>
</li>
<li>
<p>Guarda los cambios con <em>Save</em>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-tool-nodejs-lts.png" alt="jenkins tool nodejs lts">
</div>
<div class="title">Fig. 31. Configuración de herramienta NodeJS</div>
</div>
<div class="paragraph">
<p>De la misma forma, instala la última versión de Maven. En este caso dale el nombre <em>Default Maven</em> y marca instalar automáticamente.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-tool-maven-39.png" alt="jenkins tool maven 39">
</div>
<div class="title">Fig. 32. Configuración de herramienta Maven</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_primeros_ejemplos">7. Primeros ejemplos</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_creación_del_primer_proyecto_freestyle">7.1. Creación del primer proyecto freestyle</h3>
<div class="paragraph">
<p>Creamos el primer proyecto de Jenkins. Comprueba que Jenkins puede llamar a Docker. Para ello crea un nuevo proyecto tipo freestyle.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-new-hello-docker.png" alt="jenkins new hello docker">
</div>
<div class="title">Fig. 33. Nuevo proyecto, freestyle</div>
</div>
<div class="paragraph">
<p>En la sección <strong>Build Steps</strong>, añade un nuevo paso,  <strong>Ejecutar linea de comandos (shell)</strong> . Pega estos comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">whoami
git --version
java -version
docker -v</code></pre>
</div>
</div>
<div class="paragraph">
<p>Guarda los cambios. Haz clic sobre <strong>Build now</strong>. Haz clic sobre la bolita verde para ver el la <em>salida por consola</em>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-new-hello-docker-console-output-2024.png" alt="jenkins new hello docker console output 2024">
</div>
<div class="title">Fig. 34. Build now. Resultado del build</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-new-hello-docker-console-success-2024.png" alt="jenkins new hello docker console success 2024">
</div>
<div class="title">Fig. 35. Salida por consola</div>
</div>
<div class="paragraph">
<p>Por consola se visualiza el resultado de ejecutar los comandos dentro del contenedor. Como puedes ver, <code>git</code> y <code>java</code> están instalados, venían ya en la imagen  <code>jenkins:lts</code> de la que hemos partido en la definición del <code>Dockerfile</code>. Además, <code>docker</code> también está disponible, se ha instalado correctamente mediante la definición incluida en el Dockerfile. La ejecución finaliza correctamente, con el mensaje <code>Finished: SUCCESS</code>, por ello la bolita verde.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creación_del_primer_pipeline">7.2. Creación del primer pipeline</h3>
<div class="sect3">
<h4 id="_nodos_de_ejecución">7.2.1. Nodos de ejecución</h4>
<div class="paragraph">
<p>De forma predeterminada, Jenkins ejecuta los proyectos sobre el nodo principal (main), que es el nodo (contenedor o máquina virtual) donde se ejecuta el propio Jenkins.</p>
</div>
<div class="paragraph">
<p>Puedes consultar los nodos disponibles en Jenkins en la sección <strong>Administrar Jenkins</strong> &gt; <strong>Nodos</strong>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-admin-nodos-2024.png" alt="jenkins admin nodos 2024">
</div>
<div class="title">Fig. 36. Nodos disponibles en Jenkins</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hasta ahora no hemos configurado otros nodos ni <em>clouds</em> donde ejecutar los proyectos, así que por defecto se ejecutan en el principal.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pipeline_sobre_el_nodo_principal">7.2.2. Pipeline sobre el nodo principal</h4>
<div class="paragraph">
<p>Creamos el primer proyecto de Jenkins tipo <strong>pipeline</strong>. Vamos a darle el nombre <code>hello-maven-pipeline-on-master-node</code>. Este pipeline se ejecutará sobre el nodo (<code>agent</code>) master, es decir, sobre el mismo contenedor que está ejecutando Jenkins.</p>
</div>
<div class="paragraph">
<p>Copia la siguiente definición de pipeline en el bloque <strong>Pipeline</strong>, <strong>Pipeline script</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
    agent any
    tools {
        maven 'Default Maven' <i class="conum" data-value="1"></i><b>(1)</b>
    }

    stages {
        stage('Build') {
            steps {
                sh '''
                    java -version
                    mvn -v
                  ''' <i class="conum" data-value="2"></i><b>(2)</b>
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Utiliza la instalación de Maven que hemos hecho en la sección anterior, y le dimos el nombre <code>Default Maven</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>En la shell ejecutará los comandos para mostrar las versiones de Java y Maven.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Haz clic sobre <strong>Build now</strong>, y visualiza la consola. Como parte de la salida, se debe visualizar algo así (puede que los números de versiones varíen):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Pipeline] sh
+ java -version
openjdk version "17.0.10" 2024-01-16
OpenJDK Runtime Environment Temurin-17.0.10+7 (build 17.0.10+7)
OpenJDK 64-Bit Server VM Temurin-17.0.10+7 (build 17.0.10+7, mixed mode)
+ mvn -v
Apache Maven 3.9.6 (bc0240f3c744dd6b6ec2920b3cd08dcc295161ae)
Maven home: /var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/Default_Maven
Java version: 17.0.10, vendor: Eclipse Adoptium, runtime: /opt/java/openjdk
Default locale: en, platform encoding: UTF-8
OS name: "linux", version: "6.5.0-1014-gcp", arch: "amd64", family: "unix"</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lanzar las construcciones de proyectos en el nodo principal puede acarrear <strong>problemas de seguridad</strong>. De hecho, Jenkins (dependiendo de la versión) avisa de que esta configuración es inadecuada, y recomienda configurar agentes independientes donde lanzar las ejecuciones de los proyectos.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/issue-build-on-master.png" alt="issue build on master">
</div>
<div class="title">Fig. 37. Aviso de evitar ejecuciones en el nodo máster de Jenkins</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pipeline_con_un_contenedor_como_agente">7.2.3. Pipeline con un contenedor como agente</h4>
<div class="paragraph">
<p>La alternativa es que el pipeline se ejecute, en lugar de en el nodo principal, en un nodo tipo "agente" que se creará <em>ex profeso</em> a partir de un contenedor Docker disponible de DockerHub.</p>
</div>
<div class="paragraph">
<p>A continuación creamos el segundo proyecto de Jenkins tipo pipeline. Vamos a darle el nombre <code>hello-maven-pipeline-on-container-node</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
    agent {
        docker {
            image 'maven:3.9-eclipse-temurin-21-jammy' <i class="conum" data-value="1"></i><b>(1)</b>
            args '-v $HOME/.m2:/root/.m2' <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
    stages {
        stage('Build') {
            steps {
                sh '''
                    java -version
                    mvn -v
                  '''
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Elige entre las <a href="https://hub.docker.com/_/maven">imágenes de Maven</a> disponibles. En este caso, se ha elegido la versión 3.9 con Java 21, que es distinta a la que hemos instalado en el nodo principal.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mapea el volumen del host <code>$HOME/.m2</code> donde se almacenan las dependencias de Maven, para que estén disponibles en el contenedor, eliminando así la necesidad de volver a descargarlas en sucesivas ejecuciones.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Te dará error al construir el proyecto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Pipeline] sh
+ docker inspect -f . maven:3.9-eclipse-temurin-21-jammy

permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/containers/maven:3.9-eclipse-temurin-21-jammy/json": dial unix /var/run/docker.sock: connect: permission denied</code></pre>
</div>
</div>
<div class="paragraph">
<p>El motivo es que en la máquina Jenkins, sobre el S.O. host, hay que abrir permisos en el socket de Docker para que desde dentro del contenedor Jenkins permita crear otros contenedores <em>hermanos</em>. Para ello, mediante el terminal <code>ssh</code> modifica los permisos así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo chmod 666 /var/run/docker.sock</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ello deben construirse correctamente. La nueva salida será algo así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">[Pipeline] sh
+ java -version
openjdk version "21.0.2" 2024-01-16 LTS
OpenJDK Runtime Environment Temurin-21.0.2+13 (build 21.0.2+13-LTS)
OpenJDK 64-Bit Server VM Temurin-21.0.2+13 (build 21.0.2+13-LTS, mixed mode, sharing)
+ mvn -v
Apache Maven 3.9.6 (bc0240f3c744dd6b6ec2920b3cd08dcc295161ae)
Maven home: /usr/share/maven
Java version: 21.0.2, vendor: Eclipse Adoptium, runtime: /opt/java/openjdk
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "6.5.0-1014-gcp", arch: "amd64", family: "unix"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para que tras reiniciar la máquina se mantengan los permisos del socket de Docker:</p>
</div>
<div class="paragraph">
<p>Crea el archivo <code>/etc/rc.local</code>, y añade el siguiente contenido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#!/bin/sh -e
chmod 666 /var/run/docker.sock</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, dale los permisos adecuados al archivo <code>/etc/rc.local</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo chmod 755 /etc/rc.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ello reinicia la máquina.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo reboot -h now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ello, comprueba que el socket de Docker tiene los permisos adecuados:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ls -la /var/run/docker.sock
srw-rw-rw- 1 root docker 0 Mar  2 19:24 /var/run/docker.sock</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No olvides que abrir permisos aL archivo <code>/var/run/docker.sock</code> supone ciertos problemas de seguridad: <em>Avoid workarounds like this which could be a big potential security threat. The result of your chmod practically gives all local users read and write permissions to the docker-socket which allows anyone to interfere with your docker images.</em> (<a href="https://serverfault.com/questions/821062/how-to-run-sudo-chmod-666-var-run-docker-sock-on-ubuntu-before-the-services">fuente</a>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Otros ejemplos similares con contenedores NodeJS están disponibles en la <a href="https://www.jenkins.io/doc/book/pipeline/docker/">documentación de Jenkins</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_usando_varios_contenedores_como_agente">7.2.4. Usando varios contenedores como agente</h4>
<div class="paragraph">
<p>Es habitual tener varias tecnologías en un mismo proyecto. Por ejemplo, un repositorio puede tener tanto un back-end basado en Java como un front-end basado en JavaScript. Combinar Docker y Pipeline permite usar diferentes agentes en diferentes fases (<em>stages</em>) del pipeline. Crea un nuevo pipeline `hello-pipeline-multiple-containers`con el siguiente contenido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
    agent none
    stages {
        stage('Back-end') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21-jammy'
                    args '-v $HOME/.m2:/root/.m2'
                }
            }
            steps {
                sh 'mvn --version'
            }
        }
        stage('Front-end') {
            agent {
                docker { image 'node:20.11.1-alpine3.19' }
            }
            steps {
                sh 'node --version'
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-pipeline-multiple-containers-2024.png" alt="jenkins pipeline multiple containers 2024">
</div>
<div class="title">Fig. 38. Pipeline con varios contenedores como agentes</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conexión_con_la_máquina_de_despliegue">7.3. Conexión con la máquina de despliegue</h3>
<div class="paragraph">
<p>Para automatizar el despliegue sobre la instancia que tenemos creada para ello, deberás permitir que Jenkins ejecute  comandos sobre la máquina de despliegue a través de SSH. Para ello, la instancia Jenkins debe poder conectarse a la instancia de despliegue mediante una conexión SSH basada en autenticación por pareja de claves pública/privada, que ha demostrado ser más seguro sobre la autenticación estándar de nombre de usuario/contraseña.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/deploy-schema-full.png" alt="deploy schema full">
</div>
<div class="title">Fig. 39. Esquema de despliegue con Jenkins</div>
</div>
<div class="paragraph">
<p>Para ello, los pasos que se detallan a continuación permiten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>generar una nueva pareja de claves que usaremos para el despliegue,</p>
</li>
<li>
<p>copiar la clave pública generada en la instancia de despliegue,</p>
</li>
<li>
<p>y por último probar que la conexión se realiza correctamente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejecuta los siguientes pasos:</p>
</div>
<div class="sect3">
<h4 id="_generar_la_nueva_pareja_de_claves_de_despliegue">7.3.1. Generar la nueva pareja de claves de despliegue</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conecta por SSH a la máquina Jenkins: <code>ssh ubuntu@<em>instancia-jenkins</em></code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-from-developer-to-jenkins.png" alt="ssh from developer to jenkins">
</div>
<div class="title">Fig. 40. Conexión SSH a la instancia Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Crea la carpeta donde se va a guardar la nueva pareja de claves: <code>mkdir /home/ubuntu/jenkins_home/.ssh</code></p>
</li>
<li>
<p>Crea una pareja de claves ssh de despliegue: <code>ssh-keygen -t rsa -b 4096</code></p>
</li>
<li>
<p>Cuando pida el <strong>nombre</strong>, escribe el nuevo nombre <strong>id_rsa_deploy</strong> junto con la ubicación donde Jenkins va a buscar las claves de forma predeterminada, que es: <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_rsa_deploy</strong></code></p>
</li>
<li>
<p>Por último, deja la contraseña en blanco (pulsa ENTER): <code>Enter passphrase (empty for no passphrase):</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Esto crea la clave privada en <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_dsa_deploy</strong></code> y una clave pública asociada en <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_dsa_deploy.pub</strong></code>. Esta nueva pareja de claves la usaremos <strong>exclusivamente para el despliegue</strong> de nuestros proyectos.</p>
</div>
<div class="paragraph">
<p>Al haberla guardado en la carpeta <code>/home/ubuntu/jenkins_home/</code> los archivos están accesibles dentro del contenedor de Jenkins, porque como recordarás, al lanzar el contenedor Jenkins esa carpeta del host la habíamos mapeado con la carpeta <code>/var/jenkins_home</code> del contenedor.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-ls-deploy-keys.png" alt="jenkins ls deploy keys">
</div>
<div class="title">Fig. 41. Pareja de claves <em>id_rsa_deploy</em></div>
</div>
</div>
<div class="sect3">
<h4 id="_copiar_la_clave_pública_a_la_instancia_de_despliegue">7.3.2. Copiar la clave pública a la instancia de despliegue</h4>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Muestra el contenido de la clave pública:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>cat /home/ubuntu/jenkins_home/.ssh/id_rsa_deploy.pub</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Copia el contenido: con el ratón, selecciona el contenido de la clave, desde “ssh-rsa” hasta el final, y pulsa ENTER (o CTRC+C)</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-cat-public-key.png" alt="jenkins cat public key">
</div>
<div class="title">Fig. 42. Copia el contenido de <em>id_rsa_deploy.pub</em></div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Debido a que algunos terminales añaden saltos delinea al copiar texto desde el terminal, como ocurre con cloud shell de GCP, es <em>recomendable</em> copiar el contenido de la clave pública en cualquier editor de texto "plano" (Notepad++, Sublime, VS Code, etc) y eliminar los saltos de línea, si los hubiera.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>Ahora pégalo en tu PC, lo necesitaremos más adelante.</p>
</li>
<li>
<p>Desconecta de la máquina Jenkins: <code>exit</code></p>
</li>
<li>
<p>Conecta por ssh a la instancia de despliegue</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-from-developer-to-deploy.png" alt="ssh from developer to deploy">
</div>
<div class="title">Fig. 43. Conexión SSH a la instancia Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>Edita el archivo <code>authorized_keys</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>nano /home/ubuntu/.ssh/authorized_keys</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>Ese archivo ya tenía una clave pública, la correspondiente a tu pareja de claves personal que inyectamos en la creación de la instancia con Terraform (por eso has podido conectar por ssh a esa máquina). Pega el contenido de la clave pública de despliegue. Ahora debe tener 2 claves públicas.</p>
</li>
<li>
<p>Ya puedes desconectar de la instancia de despliegue.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_de_la_conexión_desde_jenkins_a_despliegue">7.3.3. Prueba de la conexión desde jenkins a despliegue</h4>
<div class="paragraph">
<p>Vamos a probar que funciona:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-ssh-to-deploy.png" alt="jenkins ssh to deploy">
</div>
<div class="title">Fig. 44. Conexión SSH desde la instancia Jenkins a la de despliegue</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>Conecta de nuevo a la instancia jenkins y prueba la conexión ssh a la instancia de despliegue. Recuerda que puesto que Jenkins se está ejecutando como un contenedor, debes probar la conexión ssh desde dentro del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker exec -it jenkins-docker ssh ubuntu@<em>instancia_deploy</em> -i /var/jenkins_home/.ssh/id_rsa_deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>En el comando anterior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker exec -it</code> indica ejecutar un comando desde dentro del contenedor</p>
</li>
<li>
<p><code>jenkins-docker</code> es el nombre del contenedor</p>
</li>
<li>
<p><code>ssh ubuntu@<em>instancia_deploy</em> -i /var/jenkins_home/.ssh/id_rsa_deploy</code> es el comando a ejecutar en el contenedor. En este caso, <code>ssh</code> con el parámetro <code>-i &#8230;&#8203;</code> para indica la clave privada que debe usar para conectar.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Antes de ejecutar el comando, modifica <code><em>instancia_deploy</em></code> por el nombre DNS de tu instancia de despliegue.</p>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Recuerda que <code>/var/jenkins_home</code> es la carpeta HOME del usuario <em>jenkins</em> dentro del contenedor, y <em>jenkins</em> es el usuario del contenedor que ejecuta Jenkins.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>La primera vez que realizas una conexión ssh desde un usuario en una máquina origen a una destino, te pregunta si deseas almacenar la clave de host de destino en la lista de hosts conocidos (<code>known_hosts</code>) de tu máquina origen. Contesta: <code>yes</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-host-autentication.png" alt="ssh host autentication">
</div>
<div class="title">Fig. 45. Validar la clave del host: <strong>yes</strong></div>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p>Si todo ha ido bien, la conexión se ha debido realizar. Puedes comprobarlo porque en el <code>prompt</code> te aparecerá que estás en la máquina de despliegue. Sal con <code>exit</code>. Ahora el <code>prompt</code> te muestra que estás en la máquina Jenkins.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-host-connection-deploy-exit.png" alt="ssh host connection deploy exit">
</div>
<div class="title">Fig. 46. Conexión correcta</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si no ha correcto, verifica que la ruta al archivo de la clave privada es correcta, y que el nombre de la máquina de despliegue es correcto.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p>Comprueba que la clave de host de la máquina de destino (despliegue) se ha guardado en la máquina origen (jenkins) en el archivo <code>~/.ssh/known_hosts</code> del usuario que ha ejecutado el comando ssh, en nuestro caso, del usuario jenkins de contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker exec -it jenkins-docker cat /var/jenkins_home/.ssh/known_hosts</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-known_hosts.png" alt="ssh known hosts">
</div>
<div class="title">Fig. 47. Contenido del archivo <strong>known_hosts</strong> en el contenedor</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p>Puedes comprobarlo también mostrando el contenido de <em>known_hosts</em> en el archivo <code>/home/ubuntu/jenkins_home/.ssh/known_hosts</code>. Ambos coinciden, recuerda que hay un volumen mapeado entre la carpeta local <code>/home/ubuntu/jenkins_home</code> y la carpeta del contenedor <code>/var/jenkins_home</code>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/ssh-known_hosts-local.png" alt="ssh known hosts local">
</div>
<div class="title">Fig. 48. Contenido del archivo <strong>known_hosts</strong> en la carpeta local</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="19">
<li>
<p>Ahora que la conexión por SSH entre la máquina Jenkins y la máquina de despliegue es correcta, vamos a hacer que Jenkins automatice la ejecución de comandos sobre la máquina de despliegue: entra en Jenkins y añade el siguiente comando al proyecto <em>hello_docker</em> existente, sustituyendo <em>MAQUINA_DEPLOY</em> por el nombre DNS de la máquina de despliegue.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ssh -i ~/.ssh/id_rsa_deploy ubuntu@MAQUINA_DEPLOY "pwd &amp;&amp; ls -la"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como aclaración de este comando:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>el parámetro <code>-i</code> indica la clave privada que queremos usar en la conexión ssh</p>
</li>
<li>
<p><code>"pwd &amp;&amp; ls -la"</code> son comandos básicos que ejecuta sobre la máquina remota. Hemos indicado estos comandos simplemente para probar que la conexión se realiza correctamente.</p>
</li>
</ul>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-hello-docker-ssh-to-deploy.png" alt="jenkins hello docker ssh to deploy">
</div>
<div class="title">Fig. 49. Modificación del proyecto para que ejecute un comando sobre la instancia de despliegue</div>
</div>
<div class="paragraph">
<p>Tras ejecutar el proyecto en Jenkins, el resultado debe ser correcto.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/jenkinsdocker/images/jenkins-hello-docker-ssh-to-deploy-output-2024.png" alt="jenkins hello docker ssh to deploy output 2024">
</div>
<div class="title">Fig. 50. Salida por consola. El comando se ha ejecutado correctamente.</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="_aplicación_web_java" class="sect0">Aplicación Web Java</h1>
<div class="openblock partintro">
<div class="content">
<div class="exampleblock">
<div class="title">Objetivos</div>
<div class="content">
<div class="paragraph">
<p>Como construir y desplegar apliaciones web Java con Jenkins</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dockerizar la aplicacion web Java para facilitar su despliegue</p>
</li>
<li>
<p>Desplegar la aplicación Java tanto de forma nativa como mediante contenedor</p>
</li>
<li>
<p>Definir un pipeline con las etapas más habituales en CI/CD</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_petclinic">8. PetClinic</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_construcción_y_ejecución_en_local">8.1. Construcción y ejecución en local</h3>
<div class="paragraph">
<p>Una vez que hemos configurado correctamente nuestro entorno de CI/CD con Jenkins, vamos a estudiar varios ejemplos tanto en Java como en NodeJs. Para comprender los ejemplos, primero los vamos a construir y ejecutar en local, para después  automatizar el proceso de construcción y despliegue con Jenkins.</p>
</div>
<div class="paragraph">
<p>En este primer ejemplo en Java, nos vamos a basar en el proyecto PetClinic con Spring Boot. <a href="https://github.com/spring-projects/spring-petclinic">Petclinic</a> es una aplicación <a href="https://spring.io/projects/spring-boot">Spring Boot</a> construida usando <a href="https://spring.io/guides/gs/maven/">Maven</a> como herramienta de soporte a la gestión y construcción (<em>build</em>).</p>
</div>
<div class="paragraph">
<p><a href="https://spring.io/projects/spring-boot">Spring Boot</a> es un framework de código abierto para el desarrollo de aplicaciones Java basadas en <a href="https://spring.io/">Spring</a>. Spring Boot genera una proyecto Maven/Gradle con todo lo necesario y que se autoconfigura en el arranque. Por ejemplo, si decimos que queremos una aplicación web, Spring Boot automáticamente embebe un Tomcat y lo configura con el servlet de Spring. Toda la configuración la añade al archivo de la herramienta de <em>build</em> que indiquemos, en caso de Maven, al archivo <strong><code>pom.xml</code></strong>.</p>
</div>
<div class="paragraph">
<p>Recordemos que <strong>Maven</strong> es una herramienta software para la gestión y construcción de proyectos Java. <a href="https://maven.apache.org/">Apache Maven</a> estandariza la configuración de un proyecto en todo su ciclo de vida, como son todas las fases de compilación, ejecución de pruebas, empaquetado, etc. Maven permite la gestión de dependencias entre módulos y distintas versiones de librerías, simplemente indicando los módulos que componen el proyecto, y las dependencias utiliza el software que estamos desarrollando, en un fichero XML de configuración llamado POM (Project Object Model).</p>
</div>
<div class="paragraph">
<p>Para el proyecto PetClinic, en tu máquina de desarrollo local puedes construir el <code>.jar</code> (empaquetado) y ejecutarlo:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Requiere JDK 11 o superior en la máquina local. Si estás en Windows y tienes varias instalaciones, <a href="https://www.happycoders.eu/java/how-to-switch-multiple-java-versions-windows/">establece la version de Java</a> predeterminada.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/spring-projects/spring-petclinic.git
cd spring-petclinic
./mvnw package <i class="conum" data-value="1"></i><b>(1)</b>
java -jar target/*.jar <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Llama a <code>mvnw</code>, el <em>warper</em> de Maven que instala Maven (si es necesario), y ejecuta el <em>goal</em> <code><strong>package</strong></code> que se encarga de compilar, ejecutar los test y empaquetar la aplicación en un único archivo ejecutable <code>.jar</code>. La primera vez que lances la construcción tardará más de 5 minutos, ya que tiene que descargar todas las dependencias necesarias desde los repositorios de Maven (Maven Central), y después lanzar los tests. Toda la configuración necesaria está contenida en el archivo <code>pom.xml</code> de Maven.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ejecuta la aplicación a partir del <code>.jar</code>. Puedes acceder a PetClinic en: <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a></td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/petclinic-homepage.png" alt="petclinic homepage">
</div>
<div class="title">Fig. 51. Página principal de PetClinic</div>
</div>
<div class="paragraph">
<p>En su configuración predeterminada, Petclinic utiliza una base de datos en memoria (H2) que se inicia con datos predeterminados, y los nuevos datos que se guarden se pierden al reiniciar la aplicación.</p>
</div>
<div class="paragraph">
<p>En caso de necesitar persistencia de los datos, PetClinic también está preconfigurada para usar MySql. Para cambiar el tipo de base de datos, la aplicación debe ejecutarse con un perfil de MySql: <code>spring.profiles.active=mysql</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">java -Dspring.profiles.active=mysql -jar target/*.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda que para ejecutarla en este modo, debes tener un MySql funcionando en local, o bien lanzar MySql como contenedor con <strong>docker</strong> o con <strong>docker-compose</strong>. Existe un archivo <code>docker-compose.yml</code> <a href="https://github.com/spring-projects/spring-petclinic/blob/main/docker-compose.yml">disponible en el repositorio</a> del proyecto PetClinic, por tanto puedes iniciar MySql así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>docker-compose.yml</code> que permite iniciar MySql y Postgres puedes consultarlo en la carpeta raíz del proyecto.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si abres el repositorio de PetClinic con VS Code, verás que el IDE te sugiere abrir el proyecto en un entorno <a href="https://code.visualstudio.com/docs/devcontainers/containers"><em>Dev Containers</em></a>. Esto <strong>no es necesario</strong>, puedes cerrar el aviso.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/vscode-devcontainer-banner.png" alt="vscode devcontainer banner">
</div>
<div class="title">Fig. 52. Aviso Dev Containers en Visual Studio Code</div>
</div>
<div class="paragraph">
<p>Pero si aceptas, se descargará una imagen de Docker con un entorno de desarrollo preconfigurado para trabajar con el proyecto, así como las imágenes de MySql y Postgres. En ese caso, al lanzar la construcción del proyecto, los tests de integración se ejecutan sobre las bases de datos MySql y Postgres.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creación_del_pipeline_para_petclinic">8.2. Creación del Pipeline para PetClinic</h3>
<div class="paragraph">
<p>Una vez que hemos probado la ejecución y funcionamiento de la aplicación PetClinic en local, vamos a configurar el proyecto en el servidor Jenkins de CI/CD para que este se encargue de la construcción y el despliegue automatizados.</p>
</div>
<div class="paragraph">
<p>Conecta a tu Jenkins, y crea un nuevo item de tipo Pipeline. Dale el nombre <code>spring-petclinic-pipeline</code>:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/new-item-pipeline-petclinic.png" alt="new item pipeline petclinic">
</div>
<div class="title">Fig. 53. New Item, PetClinic pipeline</div>
</div>
<div class="paragraph">
<p>En el bloque Pipeline, pega la configuración siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
  agent any <i class="conum" data-value="1"></i><b>(1)</b>

  tools {
    // Previamente has debido instalar Maven con el nombre "Default Maven"
    maven "Default Maven" <i class="conum" data-value="2"></i><b>(2)</b>
  }

  stages { <i class="conum" data-value="3"></i><b>(3)</b>
    stage('Git fetch') { <i class="conum" data-value="4"></i><b>(4)</b>
      steps {
        // Get some code from a GitHub repository
        git branch:'main', url:'https://github.com/spring-projects/spring-petclinic.git'
      }
    }
    stage('Compile, Test, Package') { <i class="conum" data-value="5"></i><b>(5)</b>
      steps {
        // Run goal 'package' includes compile, test and package.
        sh "mvn clean package -Dcheckstyle.skip -Dtest=!PostgresIntegrationTests*" <i class="conum" data-value="7"></i><b>(7)</b>
      }
      post { <i class="conum" data-value="6"></i><b>(6)</b>
        // If Maven was able to run the tests, even if some of the test
        // failed, record the test results and archive the jar file.
        success {
          junit '**/target/surefire-reports/TEST-*.xml'
          archiveArtifacts 'target/*.jar'
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>agente o nodo de Jenkins en que ejecuta la construcción del proyecto. En el ejemplo, <code>any</code> indica que se ejecutará cualquier nodo, en nuestro caso será en el nodo <em>principal (_master</em>) ya que es el único que hay definido.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>como herramienta para la construcción se usará maven. Pon aquí el nombre que diste a tu instalación de Maven configurada previamente en Tools Configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Bloque de <code>stages</code>: fases o etapas que conforman el pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fase de descarga del repositorio git</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fase de compilación, ejecución de test y empaquetado de la aplicación. Se realizarán con los <em>goals</em> <code>clean package</code>: primero <code>clean</code> elimina todo lo generado en la construcción anterior que se encuentra en la carpeta <code>target</code>, y a continuación se lanza la construcción con <code>package</code> tal y como está definida en el archivo <code>pom.xml</code>. La opción <code>-Dcheckstyle.skip</code> anula el análisis de CheckStyle, que lo añadiremos en una fase posterior.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Paso posterior que guarda los resultados de los test de JUnit para generar la gráfica de evolución de los test.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>La opción <code>-Dtest=!PostgresIntegrationTests*</code> excluye la ejecución de los tests de integración con Postgres, ya que estos fallan en Jenkins porque hay algún problema con el contenedor de Postgres que se inicia en la construcción del proyecto.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras ejecutar el pipeline, con "Build now", el resultado debe ser el siguiente:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/petclinic-pipeline-build-1-2024.png" alt="petclinic pipeline build 1 2024">
</div>
<div class="title">Fig. 54. Construcción del pipeline PetClinic</div>
</div>
<div class="paragraph">
<p>Si realizamos una segunda ejecución, ya aparecerá la gráfica de evolución de los tests de JUnit.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Alternativamente, podemos hacer que la construcción se realice en un agente que sea un contenedor docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
   agent {
        docker { <i class="conum" data-value="1"></i><b>(1)</b>
            image 'maven:3.9-eclipse-temurin-17-focal'
            args '-v $HOME/.m2:/root/.m2'
        }
    }

  stages {
    stage('Git fetch') {
      steps {
        // Get some code from a GitHub repository
        git branch:'main', url:'https://github.com/spring-projects/spring-petclinic.git'
      }
    }
    stage('Compile, Test, Package') {
      steps {
        // Run goal 'package' includes compile, test and package.
        sh "mvn clean package -Dcheckstyle.skip -Dtest=!PostgresIntegrationTests*"
      }
      post {
        // If Maven was able to run the tests, even if some of the test
        // failed, record the test results and archive the jar file.
        success {
          junit '**/target/surefire-reports/TEST-*.xml'
          archiveArtifacts 'target/*.jar'
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Agente donde construir el proyecto, ahora no se hace en el nodo principal sino en un contenedor docker seleccionado. La imagen de Maven que se utiliza es <code>maven:3.9-eclipse-temurin-17-focal</code>, y se monta el volumen del directorio <code>.m2</code> del usuario en el contenedor.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_informe_de_cobertura_de_código">8.3. Informe de Cobertura de código</h3>
<div class="paragraph">
<p>Jenkins nos permite publicar métricas asociadas al proyecto. Una de ellas, es la cobertura de código ejecutado por las pruebas.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>La <strong>Cobertura</strong> de código nos indica el porcentaje de código de producción que está siendo ejecutado por los test. Es deseable tener un valor de cobertura lo más próximo posible al 100%</p>
</div>
</div>
</div>
<div class="paragraph">
<p>El proyecto PetClinic contiene mas de 40 tests unitarios en JUnit, y está configurado (ver <code>pom.xml</code>) para que se calcule la cobertura cuando se lanzan los tests mediante el plugin JaCoCo (Java Code Coverage). Puedes visualizar el resultado de la cobertura en tu construcción local, en la carpeta <code>target/site/jacoco</code>:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jacoco-local-results.png" alt="jacoco local results">
</div>
<div class="title">Fig. 55. Archivos generados por JaCoCo</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jacoco-local-html-2024.png" alt="jacoco local html 2024">
</div>
<div class="title">Fig. 56. Informe html de la cobertura JaCoCo</div>
</div>
<div class="paragraph">
<p>Y si haces clic en el nombre de una clase, verás el código coloreado:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/plugins-jacoco-class-details.png" alt="plugins jacoco class details">
</div>
<div class="title">Fig. 57. Detalle la cobertura de las lineas de código</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las lineas <span class="lime-background">verdes</span> están cubiertas, es decir, han sido ejecutadas por al menos 1 test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Las lineas <span class="yellow-background">amarillas</span> están parcialmente cubiertas (<em>missed branches</em>): un resultado de la condición (verdadero/falso) ha sido ejecutado por algún test pero el otro no ha sido ejecutado por ningún test.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Las líneas <span class="red-background">rojas</span> no están cubiertas, no han sido ejecutadas por ningún test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para visualizar el resultado de la cobertura en Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instala el plugin de JaCoCo y el plugin Coverage (si no lo habías hecho antes):</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/plugins-jacoco-install-2024.png" alt="plugins jacoco install 2024">
</div>
<div class="title">Fig. 58. Instalación del plugin Jacoco</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Añade las siguientes lineas al bloque <code>post</code> para que se guarde y muestre el informe de cobertura.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  ...
  success {
    junit '**/target/surefire-reports/TEST-*.xml'
    archiveArtifacts 'target/*.jar'
    jacoco(execPattern: 'target/jacoco.exec') <i class="conum" data-value="1"></i><b>(1)</b>
    recordCoverage(tools: [[parser: 'JACOCO']], <i class="conum" data-value="2"></i><b>(2)</b>
            id: 'jacoco', name: 'JaCoCo Coverage',
            sourceCodeRetention: 'EVERY_BUILD',
            qualityGates: [
                [threshold: 60.0, metric: 'LINE', baseline: 'PROJECT', unstable: true],
                [threshold: 60.0, metric: 'BRANCH', baseline: 'PROJECT', unstable: true]])
  }
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añade el informe Coverage Trend</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Añade el informe Coverage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras la construcción de nuevo del proyecto, verás la gráfica de los resultados de los test y debajo la gráfica de evolución de cobertura:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/plugins-jacoco-dashboard-result-2024.png" alt="plugins jacoco dashboard result 2024">
</div>
<div class="title">Fig. 59. Informe de cobertura en el dashboard</div>
</div>
<div class="paragraph">
<p>Haciendo clic sobre la gráfica accedes a los detalles:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/plugins-jacoco-details-result-2024.png" alt="plugins jacoco details result 2024">
</div>
<div class="title">Fig. 60. Detalle de de cobertura</div>
</div>
</div>
<div class="sect2">
<h3 id="_análisis_estático_de_código_checkstyle">8.4. Análisis estático de código: <em>Checkstyle</em></h3>
<div class="paragraph">
<p>Para mantener y aumentar la calidad de nuestro código debemos ayudarnos, entre otras herramientas, de técnicas de <a href="https://es.wikipedia.org/wiki/An%C3%A1lisis_est%C3%A1tico_de_software"><strong>análisis estático de código</strong></a>. Básicamente, se encargan de buscar defectos en el código sin necesidad de que este se ejecute. En Java una de las más habituales es <a href="https://checkstyle.sourceforge.io/">Checkstyle</a>, aunque hay otras como FindBugs, PMD, y SonarQube que integra a los anteriores.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>CheckStyle</strong> valida el estilo del código respecto al estilo oficial de Java.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>El proyecto PetClinic tiene configurado el plugin de CheckStyle en el <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;maven-checkstyle.version&gt;3.3.1&lt;/maven-checkstyle.version&gt;
    ...
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-checkstyle-plugin&lt;/artifactId&gt;
        &lt;version&gt;${maven-checkstyle.version}&lt;/version&gt;
        ...
      &lt;/plugin&gt;
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejectutar CheckStyle en local, ejecuta el comando de maven (<code>mvn</code>) con los siguietnes <em>goals</em>: <code>mvn checkstyle:checkstyle site -DgenerateReports=false</code></p>
</div>
<div class="paragraph">
<p>Tras la ejecución, en la carpeta <code>target/site/</code> verás el archivo <code>checkstyle.html</code>:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/checkstyle-report-html-2024.png" alt="checkstyle report html 2024">
</div>
<div class="title">Fig. 61. Informe de CheckStyle</div>
</div>
<div class="paragraph">
<p>Sería labor del equipo de desarrollo revisar los errores detectados y tratar de corregirlos, siempre que realmente supongan una mejora para la calidad del código.</p>
</div>
<div class="paragraph">
<p>Para ejecutar y visualizar el informe en Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar el plugin <a href="https://github.com/jenkinsci/warnings-ng-plugin/blob/master/doc/Documentation.md#declarative-pipeline-configuration">Warnings Next Generation</a>.</p>
</li>
<li>
<p>Añadir al pipeline un nuevo <code>stage</code> con la siguiente descripción:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage ('Analysis') {
      steps {
        // Warnings next generation plugin required
        sh "mvn checkstyle:checkstyle site -DgenerateReports=false"
        recordIssues enabledForFailure: true, tool: checkStyle()
      }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la construcción, el pipeline tiene una nueva fase y además en el menú tenemos acceso al informe de CheckStyle.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/checkstyle-report-dashboard-2024.png" alt="checkstyle report dashboard 2024">
</div>
<div class="title">Fig. 62. Pipeline con la nueva fase de Análisis</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/checkstyle-report-details-2024.png" alt="checkstyle report details 2024">
</div>
<div class="title">Fig. 63. Detalles del informe de CheckStyle</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Saber más&#8230;&#8203;</div>
<div class="paragraph">
<p>Si estás interesado en profundizar en este tema, te recomiendo integrar <a href="https://www.sonarqube.org/">SonarQube</a> con Jenkins, ya que SonarQube realiza un análisis mucho más detallado de la calidad y seguridad del código, realizando tanto análisis estático de código (CheckStyle y otros), como de análisis de seguridad (vulnerabilidades), y definiendo lo que denomina <a href="https://docs.sonarqube.org/latest/user-guide/quality-gates/"><em>Quality Gates</em></a> que permiten definir condiciones que se deben cumplir basadas en los valores de las métricas del proyecto (por ejemplo, que la cobertura de código sea mayor del 80%). Puedes encontrar mucha documentación online sobre cómo hacerlo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.sonarqube.org/latest/setup/get-started-2-minutes/">Instalar SonarQube</a> como aplicación o como contenedor Docker (recomendado)</p>
</li>
<li>
<p>Instalar el plugin <a href="https://plugins.jenkins.io/sonar/">SonarQube Scanner for Jenkins</a></p>
</li>
<li>
<p><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/#header-1">Configurar</a> SonarQube Scanner for Jenkins</p>
</li>
<li>
<p><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/#header-6">Añadir al pipeline</a> la fase de análisis de Sonar (<em>Declarative pipeline example:</em>). Más info de Sonar en pipeline: <a href="https://www.jenkins.io/doc/pipeline/steps/sonar/#sonarqube-scanner-for-jenkins">SonarQube Scanner for Jenkins</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además, Si tu proyecto está en un repositorio público en GitHub, puedes ahorrarte tener que instalar tu propio SonarQube utilizando <a href="https://sonarcloud.io/">SonarCloud</a>, el servicio de SonarQube en la nube (SaaS) gratuito para proyectos públicos, con el que evitas tener que instalar y mantener tu propio SonarQube.</p>
</div>
<div class="paragraph">
<p>Para lanzar el análisis de Sonar con maven:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Genera el login <a href="https://docs.sonarqube.org/latest/user-guide/user-token/">TOKEN</a></p>
</li>
<li>
<p>Ejecuta los goals de maven: <code>clean verify sonar:sonar -Dsonar.login=$SONAR_LOGIN_TOKEN</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Incluso puedes configurar SonarCloud y Jenkins para que  <a href="https://blog.jdriven.com/2019/08/sonarcloud-github-pull-request-analysis-from-jenkins/">analizar los <em>pull request</em></a> de tu repositorio y conocer el resultado del análisis de Sonar antes de hacer el <em>merge</em> del pull request.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_la_vm">8.5. Despliegue en la VM</h3>
<div class="paragraph">
<p>Para desplegar la aplicación PetClinic en la instancia de despliegue vamos a copiar sobre ella el archivo JAR y a continuación ejecutaremos en ella la orden de java para ponerla en marcha:</p>
</div>
<div class="paragraph">
<p>Copia este nueva fase en tu pipeline, sustituyendo DEPLOY_MACHINE por la IP o el nombre DNS de tu instancia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  stage('Deploy'){
    steps {
      sh '''
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "mkdir -p ~/spring-petclinic" <i class="conum" data-value="1"></i><b>(1)</b>
        scp -i ~/.ssh/id_rsa_deploy $WORKSPACE/target/*.jar ubuntu@DEPLOY_MACHINE:~/spring-petclinic <i class="conum" data-value="2"></i><b>(2)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "if pgrep java; then pkill java; fi" <i class="conum" data-value="3"></i><b>(3)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "nohup java -jar ~/spring-petclinic/*.jar &gt; ~/spring-petclinic/yourservice.log 2&gt;&amp;1 &amp;" <i class="conum" data-value="4"></i><b>(4)</b>
      '''
    }
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crea la carpeta <code>spring-petclinic</code> dentro de la carpeta HOME del usuario <code>ubuntu</code> en la máquina de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Copia con <code>scp</code> el archivo <code>.jar</code>, que se ha generado tras la construcción con maven, en la máquina de despligue</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Detiene el proceso <code>java</code> si existe de un despliegue anterior.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ejecuta la aplicación java empaquetada en el <code>.jar</code>, en background y con <code>nohup</code>, que hace que el proceso siga funcionando incluso si el usuario que lo inició cierra la sesión. De esta manera finaliza el comando ssh y el proceso sigue funcionando, es decir, la aplicación PetClinic estará desplegada y funcionando.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras ello abre la máquina de despliegue en el puerto 8080, y verás la aplicación PetClinic funcionando.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/petclinic-deployed.png" alt="petclinic deployed">
</div>
<div class="title">Fig. 64. Homepage PetClinic</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://medium.com/@weblab_tech/how-to-publish-artifacts-in-jenkins-f021b17fde71">How to build on Jenkins and publish artifacts via ssh with Pipelines</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_petclinic_con_docker">9. PetClinic con Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para realizar el despliegue de PetClinic como contenedor, primero tenemos que <a href="https://www.callicoder.com/spring-boot-docker-example/">dockerizar</a> la aplicación, luego publicar la imagen de contenedor en un registro como DockerHub o Google Container Registry, y por último ejecutar el contenedor en la instancia de despliegue.</p>
</div>
<div class="paragraph">
<p>El contenedor para el despliegue de PetClinic se construirá a partir de un <code>Dockerfile</code> que definirá cómo se construye la imagen del contenedor, y cómo se ejecuta la aplicación en el contenedor. Utilizará la base de datos H2 embebida. Este contenedor para el despliegue de PetClinic será independiente de la configuración <em>Dev Containers</em> que ya posee el proyecto PetClinic, así como del entorno <em>docker-compose</em>. Se podría haber optado por desplegar PetClinic con <em>docker-compose</em>, pero en este caso vamos a desplegarlo como un contenedor independiente.</p>
</div>
<div class="paragraph">
<p>A continuación se describe cómo crear un contenedor Docker de la aplicación PetClinic. Los pasos se realizan en local, y al final configuraremos el pipeline de Jenkins para que se realicen automáticamente.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para trabajar con contenedores Docker en tu equipo local, debes tener Docker instalado. Recuerda iniciar Docker Desktop en Windows, o iniciar el servicio Docker en Linux o Mac. Comprueba que está funcionado ejecutando el comando <code>docker ps</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hasta ahora nos estamos basando en el proyecto <em>PetClinic</em> original (genéricamente llamado <em>upstream</em>) disponible en <a href="https://github.com/spring-projects/spring-petclinic">GitHub</a>. En esta sección necesitarás poder hacer cambios sobre el mismo, básicamente vamos a añadir al proyecto un archivo <code>Dockerfile</code> y un archivo <code>Jenkinsfile</code>, así que crea un <em>fork</em> y trabaja con tu <em>fork</em> a partir de ahora. Verás que en los bloques de código de este documento indica como URL del repositorio <code><a href="https://github.com/ualcnsa/spring-petclinic.git" class="bare">https://github.com/ualcnsa/spring-petclinic.git</a></code>, que deberás cambiar por la URL de tu repositorio forkeado.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_creación_del_dockerfile_multi_stage">9.1. Creación del <code>Dockerfile</code> multi-stage</h3>
<div class="paragraph">
<p>Para construir aplicaciones Maven con Docker y luego <a href="https://spring.io/guides/gs/spring-boot-docker/">crear el contendedor de Docker</a> que empaquete la aplicación, la opción recomendada es usar <a href="https://docs.docker.com/get-started/09_image_best/#multi-stage-builds"><strong>Multi-Stage Builds</strong></a> en tu Dockerfile, de manera que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una primera fase o <em>stage</em> construye el <code>.jar</code> a partir de una imagen de Maven, como por ejemplo <code>maven:3.9-eclipse-temurin-17-focal</code></p>
</li>
<li>
<p>Y luego en una segunda fase, ese <code>.jar</code> lo copia en el contenedor basado en la imagen Alpine (slim) con Java 17, que es el entorno de ejecución Java necesario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La documentación de PetClinic indica cómo construir el contenedor usando <a href="https://github.com/spring-projects/spring-petclinic#building-a-container">Spring Boot build plugin</a>. A nosotros nos interesa ver cómo hacerlo de forma genérica para cualquier aplicación Java basada en Maven. Vamos a definir el siguiente archivo <code>Dockerfile</code> que debe estar en la carpeta raíz del proyecto PetClinic:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile multi-stage</div>
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM maven:3.9-eclipse-temurin-17-focal AS build <i class="conum" data-value="1"></i><b>(1)</b>
WORKDIR /app
# First copy only the pom file. This is the file with less change
COPY ./pom.xml .
# Download the package and make dependencies cached in docker image
RUN mvn -B -f ./pom.xml -s /usr/share/maven/ref/settings-docker.xml clean dependency:go-offline
# Copy the actual code
COPY ./ .
# Then build the code
RUN mvn -B -f ./pom.xml -s /usr/share/maven/ref/settings-docker.xml clean package

# Start with a base image containing Java runtime
FROM maven:3.9.6-eclipse-temurin-17-alpine <i class="conum" data-value="2"></i><b>(2)</b>
# Make port 8080 available to the world outside this container
EXPOSE 8080
# The application's jar file
ARG JAR_FILE=target/*.jar
# Copy the application's jar to the container
COPY ${JAR_FILE} app.jar
# Run the jar file
ENTRYPOINT ["java","-jar","/app.jar"]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Primera fase o <em>stage</em> de <em>build</em>, construye la aplicación llamando a los goals <code>clean package</code> de Maven. Contiene los pasos básicos para construir una aplicación Java basada en Maven. Dicha construcción la divide en dos partes, primero copia el <code>pom.xml</code> y descarga las dependencias con <code>dependency:go-offline</code>, y luego copia todos los fuentes y construye el proyecto con <code>package</code>. De esta forma se optimiza la reconstrucción del contenedor ya que la descarga de dependencias es una etapa que dura varios minutos.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Segunda fase, crea una imagen basada en la imagen Alpine de Java 17. Esta imagen está basada en el proyecto Alpine Linux que es una distribución mucho más pequeña (~5MB), y por tanto genera imágenes más pequeñas en general. Contiene los pasos básicos para ejecutar una aplicación String Boot en un contenedor: partiendo de una imagen alpine (slim), copia el archivo <code>target/*.jar</code> en el contenedor con el nombre <code>app.jar</code> y lo ejecuta mediante el comando <code>ENTRYPOINT</code> para que no haya ninguna shell sobre el proceso <code>java</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Construye el contenedor con <code>docker build</code>, y ten paciencia, tardará varios minutos!!!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker build -t petclinic-docker .</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/docker-build-petclinic-2024.png" alt="docker build petclinic 2024">
</div>
<div class="title">Fig. 65. Docker build</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si estás trabajando en Windows, la <a href="https://forums.docker.com/t/formatting-violations-found-in-the-java-files-when-docker-run/119576">construcción podría dar un error</a> por problemas de codificación de los saltos de línea diferentes entre Windows y Linux. Para resolverlo, sustituye en la primera fase del Dockerfile la linea de construcción que llama a <code>package</code> por estas dos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker"># Then build the code - on Linux <i class="conum" data-value="1"></i><b>(1)</b>
# RUN mvn -B -f ./pom.xml -s /usr/share/maven/ref/settings-docker.xml clean package

# Then build the code - On Windows <i class="conum" data-value="2"></i><b>(2)</b>
RUN mvn -B -f ./pom.xml -s /usr/share/maven/ref/settings-docker.xml clean spring-javaformat:apply --no-transfer-progress
RUN mvn -B -f ./pom.xml -s /usr/share/maven/ref/settings-docker.xml package --no-transfer-progress</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejecución de maven <code>package</code> para la construcción del proyecto cuando ejecutas Docker en Linux. La linea aparece comentada.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ejecución de maven <code>package</code> para la construcción del proyecto cuando ejecutas Docker en Windows. Las dos lineas se ejecutan (no están comentadas).</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras la construcción de la imagen, prueba la ejecución del contenedor en local:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -it -p 8080:8080 -t petclinic-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprueba que se ha iniciado la aplicación en <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.</p>
</div>
<div class="paragraph">
<p>Para el contenedor con CTRL+C.</p>
</div>
<div class="paragraph">
<p>Una vez creada la imagen con <code>docker build</code> y probada su ejecución con <code>docker run</code>, el siguiente paso será publicar la imagen en un registro de contenedores, mediante <code>docker push</code>. Podemos usar <a href="https://hub.docker.com/">DockerHub</a> pero en este caso vamos a usar Google Cloud <a href="https://cloud.google.com/artifact-registry/docs?hl=es">Artifact Registry</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_autenticación_en_artifact_registry">9.2. Autenticación en Artifact Registry</h3>
<div class="paragraph">
<p>Para poder hacer <code>push</code> de la imagen del contenedor a un registro de contenedores, como Google Artifact Registry, debemos tener permisos de escritura, y por tanto debemos autenticarnos en el servicio Artifact Registry.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Container Registry era hasta ahora el servicio de Google Cloud para el registro de contenedores, pero ha sido reemplazado por Artifact Registry. Aunque Container Registry sigue funcionando, se recomienda usar Artifact Registry.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/container-registry-deprecated.png" alt="container registry deprecated">
</div>
<div class="title">Fig. 66. Container Registry is deprecated</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://cloud.google.com/container-registry/docs/advanced-authentication">Authentication</a> permite conectar al Registro de Contenedores con tus credenciales, y  hacer push y pull de imágenes. Para ello debes configurar los los permisos necesarios para accdeder al registro, utilizando un  <a href="https://cloud.google.com/container-registry/docs/advanced-authentication#json-key">JSON key file</a> como método de autenticación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En la Consola Google Cloud, seleccionar el proyecto Google Cloud.</p>
</li>
<li>
<p>En el menú de navegación seleccionar <code>IAM y administración | <a href="https://console.cloud.google.com/apis/credentials/serviceaccountkey">Cuentas de servicio</a></code>.</p>
</li>
<li>
<p>Seleccionar <code>Crear cuenta de servicio</code>.</p>
</li>
<li>
<p>Darle un nombre (p.e. <code>container-registry</code>)</p>
</li>
<li>
<p>Seleccionar "Crear y continuar".</p>
</li>
<li>
<p>En el paso <code>Conceder a esta cuenta de servicio acceso al proyecto</code> del asistente, seleccionar el rol <code>Cloud Storage &#8594; Administrador de almacenamiento</code>. Continuar y Listo.</p>
</li>
<li>
<p>Editar la Cuenta de servicio. En la sección <code>Claves</code> seleccionar <code>Agregar clave | Crear nueva clave</code>.</p>
</li>
<li>
<p>Dejar <code>JSON</code> en el tipo de clave.</p>
</li>
<li>
<p>Seleccionar <code>Crear</code>. A continuación se descargará la clave privada.</p>
</li>
</ul>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/cloud-containers-registry-key-create.png" alt="cloud containers registry key create">
</div>
<div class="title">Fig. 67. Creación Service Account Key for pull/push on Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Guarda el archivo <code>.json</code> en la carpeta <code>secret</code> de tu proyecto PetClinic.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No olvides añadir la carpeta <code>secret/</code> al archivo <code>.gitignore</code> para evitar publicar en GitHub tu archivo de credenciales.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><em>Use the service account key as your password to authenticate with Docker.</em> Sustituye <code>keyfile.json</code> por el nombre de tu archivo de credenciales:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>En Linux:</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat keyfile.json | docker login -u _json_key --password-stdin https://gcr.io</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a" start="2">
<li>
<p>En Windows:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker login -u _json_key --password-stdin https://gcr.io &lt; keyfile.json</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/cloud-containers-registry-login.png" alt="cloud containers registry login">
</div>
<div class="title">Fig. 68. Autenticación de Docker contra Container Registry</div>
</div>
</div>
<div class="sect2">
<h3 id="_publicación_y_despliegue_manual">9.3. Publicación y despliegue <em>manual</em></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Construir el contenedor con el nombre completo incluyendo la referencia a Container registry (gcr.io). Primero definimos una variable de entorno con el nombre de nuestro proyecto GCP, y luego construimos de nuevo la imagen con el nombre completo del registro de contenedores:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">GOOGLE_CLOUD_PROJECT=cnsa-2022-user123

docker build -t gcr.io/$GOOGLE_CLOUD_PROJECT/petclinic:1.0 .</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>A continuación vamos a publicar con <code>docker push</code>: habilita la API de Container Registry en tu proyecto GCP, accediendo en el menú a Container Registry &gt; Images:</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/container-registry-habilitar-api.png" alt="container registry habilitar api">
</div>
<div class="title">Fig. 69. Habilitar la API Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Publica la imagen con <code><code>docker push [HOSTNAME]/[PROJECT-ID]/[IMAGE]:[TAG]</code></code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker push gcr.io/$GOOGLE_CLOUD_PROJECT/petclinic:1.0</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Comprueba que se ha publicado correctamente.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/container-registry-pushed-petclinic.png" alt="container registry pushed petclinic">
</div>
<div class="title">Fig. 70. Lista de imágenes en Container Registry</div>
</div>
<div class="paragraph">
<p>La imagen del contenedor PetClinic ya está disponible en el registro privado de nuestro proyecto GCP. Utilizando nuestras credenciales podremos hacer <code>docker pull</code> de dicha imagen para descargarla en cualquier máquina con docker, y ejecutarlo con <code>docker run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">GOOGLE_CLOUD_PROJECT=cnsa-2022-user123

docker run -p 8080:8080 -t --name petclinic  gcr.io/$GOOGLE_CLOUD_PROJECT/petclinic:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si conectas a la instancia de despliegue que creamos al principio de esta actividad, y ejecutas el comando <code>docker run</code> anterior, dará un error de autenticación:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/docker-run-petclinic-webapp-error-authentication.png" alt="docker run petclinic webapp error authentication">
</div>
<div class="title">Fig. 71. Error de autenticación en Container Registry</div>
</div>
<div class="paragraph">
<p>Para arreglarlo, habrá que copiar en la máquina de despliegue el archivo de credenciales <code>.json</code> con premisos sobre Container Registry. A continuación se muestran los comandos necesarios para ello. Una vez disponible este archivo en la instancia de despliegue ejecutar el comando <code>docker login</code> y tras ello ya si podremos hacer <code>docker pull</code> y <code>docker run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Compiamos el archivo de credenciales
scp ./secret/file.json ubuntu@DNS_MAQUINA_DEPLOY:~/keyfile.json
# Conectamos a la máquina de despliegue
ssh ubuntu@DNS_MAQUINA_DEPLOY
# Autenticamos docker contra Container Registry
cat keyfile.json | docker login -u _json_key --password-stdin https://gcr.io
# Variable de entorno con el nombre del proyecto
GOOGLE_CLOUD_PROJECT=cnsa-2022-user123
# ejecutamos el contenedor desde gcr.io
docker run -d -p 8080:8080 -t --name petclinic gcr.io/$GOOGLE_CLOUD_PROJECT/petclinic:1.0</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si la ejecución de <code>docker run</code> te da error, prueba a ejecutarlo con <code>sudo</code>. Para evitar tener que escribir siempre <code>sudo</code> delante de cualquier comando <code>docker</code>, ejecuta: <code>sudo usermod -aG docker $USER</code>. Tras ello, reinicia la sesión. Prueba ahora sin <code>sudo</code>, a partir de ahora llama siempre a docker sin <code>sudo</code>. Más info <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">aquí</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Es posible que la ejecución del contenedor de un error, porque el puerto 8080 ya esté en uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Error starting userland proxy: listen tcp 0.0.0.0:8080: bind: address already in use.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionarlo, bien detén el proceso java que está corriendo con la aplicación PetClinic tal y como la desplegamos en la sección anterior (<code><code>if pgrep java; then pkill java; fi</code></code>), o bien utiliza otro puerto, por ejemplo, el 80, que debe estar disponible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -p 80:8080 -t --name petclinic gcr.io/$GOOGLE_CLOUD_PROJECT/petclinic:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pero ten en cuenta que si el contenedor ya se ha creado y no ha podido iniciarse porque el puerto 8080 estaba ocupado, si intentas volver a crearlo con <code>docker run</code> te dirá que el contenedor ya existe. Revisa si está ya creado y en ese caso inícialo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ubuntu@web-deploy-vm-tf:~$ docker ps -a
CONTAINER ID   IMAGE                            COMMAND                CREATED              STATUS    PORTS     NAMES
6e174d959f3b   gcr.io/cnsa-2022/petclinic:1.0   "java -jar /app.jar"   About a minute ago   Created             petclinic

ubuntu@web-deploy-vm-tf:~$ docker start petclinic
petclinic</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ya puedes comprobar en tu navegador que la aplicación PetClinic se está ejecutando en el puerto 8080 de la máquina de despliegue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_integración_y_despliegue_continuo">9.4. Integración y despliegue continuo</h3>
<div class="paragraph">
<p>Hasta ahora hemos realizado todos los pasos de construcción, prueba y despliegue manualmente. A continuación, vamos a automatizar en Jenkins todo el proceso, cuyas principales tareas son:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>la <strong>construcción</strong> de la imagen del contenedor,</p>
</li>
<li>
<p>la <strong>publicación</strong> de la imagen en el registro, y</p>
</li>
<li>
<p>el <strong>despliegue</strong> del contenedor.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>En Jenkins, son necesarios los siguientes plugins para trabajar con Docker y pipelines, y con Container Registry: Docker Pipeline, que ya está instalado, y tendrás que instalar <a href="https://plugins.jenkins.io/google-container-registry-auth">Google Container Registry Auth</a>.</p>
</div>
<div class="paragraph">
<p>Definimos un nuevo proyecto en Jenkins de tipo pipeline, con el nombre <code><code>PetClinic-Docker-abc123</code></code> sustituyendo abc123 por nuestro nombre de usuario. Son necesarios 3 fases (stages) en el pipeline: <em>build image</em>, <em>push image</em>, y <em>deploy container</em>.</p>
</div>
<div class="sect3">
<h4 id="_construcción_y_despliegue_del_contenedor">9.4.1. Construcción y despliegue del contenedor</h4>
<div class="paragraph">
<p>Comenzamos por la <strong>construcción de la imagen</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
  agent any
  environment {
    CONTAINER_REGISTRY = 'gcr.io'
    GOOGLE_CLOUD_PROJECT = 'cnsa-2022-abc123'
    CREDENTIALS_ID = 'cnsa-2022-gcr'
  }
  tools {
    maven "Default Maven"
  }
  stages {
    stage("Checkout code") {
      steps {
        // checkout scm
        git  branch:'main', url:'https://github.com/ualcnsa/spring-petclinic.git'
      }
    }
    stage('Compile, Test, Package') {
      steps {
        sh "mvn clean package -Dcheckstyle.skip"
      }
      post {
        success {
          junit '**/target/surefire-reports/TEST-*.xml'
          archiveArtifacts 'target/*.jar'
        }
      }
    }
    stage("Build image") {
      steps {
        script {
          dockerImage = docker.build(
            "${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/petclinic:${env.BUILD_ID}",
            "--rm -f Dockerfile ."
          )
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si consultas la salida por consola de la ejecución del pipeline, verás que se algunas tareas se repiten dos veces, como por ejemplo la ejecución de los tests. ¿Por qué crees que es debido? ¿Podría eliminarse alguna fase del pipeline?</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para probar que la imagen del contenedor se ha creado bien, añade esta fase que hace un despliegue en un entorno de "Staging" o "Testing", que en este tutorial va a ser "local" en la propia máquina de Jenkins, es decir, ejecuta un contenedor basado en la imagen que acabamos de crear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage("Deploy to Testing (locally)") {
      steps {
        sh "docker stop petclinic || true &amp;&amp; docker rm  petclinic || true" <i class="conum" data-value="1"></i><b>(1)</b>
        sh "docker run -d -p 8080:8080 -t --name petclinic ${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/petclinic:${env.BUILD_ID}" <i class="conum" data-value="2"></i><b>(2)</b>
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Por si ya se ha ejecutado el pipeline anteriormente, y no se ha eliminado el contenedor de la ejecución anterior, es necesario comprobar si el contenedor <code>petclinic</code> ya se está ejecutando y, en tal caso, pararlo con <code>docker stop</code> y eliminarlo con <code>docker rm</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Con <code>docker run</code> ejecuta el contenedor <code>petclinic</code> a partir de la imagen recién construida. Para que  el pipeline pueda finalizar y el contenedor siga ejecutándose, se añade <code>-d</code> que indica modo <em>detached</em> que ejecuta el contenedor en background.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La aplicación debe estar accesible en el puerto <code>8080</code> en tu máquina de Jenkins. Para asegurarnos que la aplicación se está ejecutando bien, debemos probarlo "manualmente". Para automatizar esta prueba, lo adecuado sería realizar unos tests end-to-end, con <a href="https://www.selenium.dev">Selenium</a>. Esto se explicará en otra actividad, dedicada al testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('End-to-end Test image') {
        // Ideally, we would run some end-to-end tests against our running container.
        steps{
            sh 'echo "End-to-end Tests passed"'
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_publicación_en_el_registro">9.4.2. Publicación en el registro</h4>
<div class="paragraph">
<p>El siguiente paso es <strong>publicar la imagen</strong> en el registro.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primero, es necesario crear unas credenciales en Jenkins para poder hacer <code>push</code> en Container Registry:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Go to jenkins home, Manage Jenkins, click on “Manage credentials” and “(global)”</em></p>
</li>
<li>
<p><em>Click on “Add Credentials” in left menu.</em></p>
</li>
<li>
<p><em>Select <strong>Google Service Account from private key</strong> for the “Kind” field, and enter your project. Then upload the JSON private key.</em></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jenkins-credentials-container-registry.png" alt="jenkins credentials container registry">
</div>
<div class="title">Fig. 72. Credenciales en Jenkins para Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Una vez guardadas las credenciales, vamos a definir la fase para publicar la imagen del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  stage("Push image") {
    steps {
      script {
        docker.withRegistry('https://'+ CONTAINER_REGISTRY, 'gcr:'+ GOOGLE_CLOUD_PROJECT) {
          dockerImage.push("latest")
          dockerImage.push("${env.BUILD_ID}")
        }
      }
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprobar que se ha publicado correctamente en el registro.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jenkins-published-container-registry.png" alt="jenkins published container registry">
</div>
<div class="title">Fig. 73. Imagen publicada en Container Registry, etiquetada con el número de build</div>
</div>
</div>
<div class="sect3">
<h4 id="_despliegue_en_producción">9.4.3. Despliegue en producción</h4>
<div class="paragraph">
<p>Por último, quedaría el paso de <strong>desplegar al entorno de producción</strong>. Una vez empaquetada como un contenedor, Google Cloud permite desplegar de varias formas:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>en <strong>máquina virtual</strong> con GCE,</p>
</li>
<li>
<p>en plataforma como servicio con <strong>Google App Engine</strong>,</p>
</li>
<li>
<p>en Kubernetes con <strong>GKE</strong>,</p>
</li>
<li>
<p>y en <strong>Cloud Run</strong>, un servicio de Google Cloud específico para el despliegue de contenedores.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Para nosotros, la <strong>máquina virtual de despliegue</strong> es nuestro entorno de producción en el que vamos a desplegar el contenedor.</p>
</div>
<div class="paragraph">
<p>Los pasos para el despliegue de la nueva imagen del contenedor consistirán en ejecutar los siguientes comandos sobre la máquina de despliegue:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker stop</code> del contenedor por si estuviera ejecutándose</p>
</li>
<li>
<p><code>docker rm</code> para eliminar el contenedor existente, que puede estar basado en una imagen de una versión anterior</p>
</li>
<li>
<p><code>docker run</code> para ejecutar el contenedor, que automáticamente  hará un <code>docker pull</code> de la imagen actualizada del registro. Lo lanzaremos en el puerto 80 ya que el 8080 está ocupado por el despliegue que hicimos sin contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas acciones debemos añadirlas a un <code>stage</code> del pipeline de Jenkins que se encargará de desplegar el nuevo contenedor automáticamente. En el siguiente código, sustituye <code>DNS_DEPLOY_INSTANCE</code> por el nombre DNS de tu instancia de despliegue. También puedes definirla como una variable de entorno al inicio del pipeline.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Deploy to Production') {
      steps{
        // Check to manual approving deploy to production.
        // It implemenents Continuous Delivery instead of Continuous Deployment
        input message: "Proceed Deploy to Production?" <i class="conum" data-value="1"></i><b>(1)</b>
        sh '''
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "if docker ps -q --filter name=petclinic | grep . ; then docker stop petclinic ; fi" <i class="conum" data-value="2"></i><b>(2)</b>
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "if docker ps -a -q --filter name=petclinic | grep . ; then docker rm -fv petclinic ; fi" <i class="conum" data-value="3"></i><b>(3)</b>
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "docker run -d -p 80:8080 -t --name petclinic ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/petclinic:latest" <i class="conum" data-value="4"></i><b>(4)</b>
        '''
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pide confirmación al usuario, que tendrán que pulsar un botón de <em>Proceed</em> para continuar la ejecución del pipeline. Permite asegurar que el despliegue a producción requiere intervención de una persona, implementando entrega continua (continuous delivery) en lugar de despliegue continuo (continuous deployment).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ejecuta en la instancia de despliegue el comando <code>docker stop</code> que detiene el contenedor <code>petclinic</code> en caso de que ya se estuviera ejecutando de un despliegue anterior. Esto se comprueba con <code>docker ps &#8230;&#8203;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ejecuta en la instancia de despliegue el comando <code>docker rm</code> que elimina el contenedor <code>petclinic</code> en caso de que exista de un despliegue anterior. Esto se comprueba con <code>docker ps -a &#8230;&#8203;</code>. Estos dos pasos, primero parar el contenedor y luego eliminar el contenedor, son necesarios antes de volver a lanzar un nuevo contenedor con el mismo nombre. Se ejecuta en dos pasos para evitar errores en caso de que el contenedor exista pero no esté en ejecución, lo que podría dar lugar a un error en el despliegue.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ejecuta en la instancia de despliegue el comando para ejecutar el contenedor basado en la última versión de la imagen, lanzándolo con <code>-d</code> que indica modo <em>detached</em> que ejecuta el contenedor en background, para que el pipeline finalice y el contenedor permanezca en ejecución.</td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jenkins-proceed-to-deploy-production.png" alt="jenkins proceed to deploy production">
</div>
<div class="title">Fig. 74. Proceed deploy to production?</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Algunos <a href="https://www.docker.com/sites/default/files/d8/2019-09/docker-cheat-sheet.pdf">comandos</a> útiles de Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># Remove all stopped containers
docker rm $(docker ps -a -q)
# Remove all images
docker rmi $(docker images -q)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Úsalos si te aparece algún mensaje de error del tipo <code>no space left on device</code>, ya que la máquina Jenkins están construyendo muchas imágenes y se queda sin espacio de disco.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La aplicación PetClinic debe estar accesible <em>en producción</em>, en el puerto 8080 en la instancia de despliegue. Para asegurarnos, debemos probarlo "manualmente". Para automatizar esta prueba <em>en producción</em>, lo adecuado de nuevo sería realizar unos tests end-to-end, con <a href="https://www.selenium.dev">Selenium</a>. Esto se explicará en otra actividad, dedicada al testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('End-to-end Test on Production') {
        // Ideally, we would run some end-to-end tests against our running container.
        steps{
            sh 'echo "End-to-end Tests passed on Production"'
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, es una buena práctica eliminar las imágenes que se van generando en cada build, para liberar espacio en la máquina de Jenkins. Primero paramos y eliminamos el contenedor que desplegamos anteriormente en la fase del pipeline <code>Deploy to Testing (locally)</code>; luego eliminamos la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Remove Unused docker image') {
      steps{
        // input message:"Proceed with removing image locally?" <i class="conum" data-value="1"></i><b>(1)</b>
        sh 'if docker ps -q --filter name=petclinic | grep . ; then docker stop petclinic &amp;&amp; docker rm -fv petclinic; fi' <i class="conum" data-value="2"></i><b>(2)</b>
        sh 'docker rmi ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/petclinic:$BUILD_NUMBER' <i class="conum" data-value="3"></i><b>(3)</b>
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pide confirmación al usuario, que tendrán que pulsar un botón de <em>Proceed</em> para continuar la ejecución del pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para y elimina el contenedor <em>local</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Elimina la imagen de contenedor en <em>local</em> con <code>docker rmi</code> para liberar espacio.</td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jenkins-petclinic-full-pipeline-proceed.png" alt="jenkins petclinic full pipeline proceed">
</div>
<div class="title">Fig. 75. Input message (paso comentado en el ejemplo)</div>
</div>
<div class="paragraph">
<p>El pipeline completo, con todas sus fases, debe quedar así:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/java-web-app/images/jenkins-petclinic-full-pipeline.png" alt="jenkins petclinic full pipeline">
</div>
<div class="title">Fig. 76. Pipeline completo</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>ENHORABUENA!!!</strong> Has conseguido definir un pipeline completo de integración y despliegue continuos, y con contenedores. Este proceso se puede aplicar, con pequeñas adaptaciones, a cualquier otro proyecto Java basados en Maven.</p>
</div>
<div class="paragraph">
<p>Si usas otras tecnologías, como NodeJs, hay que adaptar cada una de las fases a su equivalente en en la tecnología concreta. Vamos a ver como hacerlo con NodeJs en la siguiente sección.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy via ssh: <a href="https://medium.com/@weblab_tech/how-to-publish-artifacts-in-jenkins-f021b17fde71">How to build on Jenkins and publish artifacts via ssh with Pipelines</a> @ Medium</p>
</li>
<li>
<p><a href="https://medium.com/@gustavo.guss/jenkins-building-docker-image-and-sending-to-registry-64b84ea45ee9">Jenkins Building Docker Image and Sending to Registry</a> @ Medium</p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/54573068/pushing-docker-image-through-jenkins">Pushing docker image through jenkins</a> @ StackOverflow</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="_aplicación_en_node_js" class="sect0">Aplicación en Node.js</h1>
<div class="openblock partintro">
<div class="content">
<div class="exampleblock">
<div class="title">Objetivos</div>
<div class="content">
<div class="paragraph">
<p>Como construir y desplegar apliaciones web Node.js con Jenkins</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dockerizar la aplicacion Node.js para facilitar su despliegue</p>
</li>
<li>
<p>Desplegar la aplicación Node.js tanto de forma nativa como mediante contenedor</p>
</li>
<li>
<p>Definir un pipeline para automatizar las etapas más habituales en CI/CD</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hola_mundo_en_node_js">10. <em>Hola mundo</em> en Node.js</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A continuación se muestra un ejemplo de <strong>integración y despliegue continuos en Jenkins de un proyecto NodeJs</strong>. Los pasos a realizar son similares al ejemplo anterior con Java, el decir, el pipeline tendrá las mismas fases; eso si, adaptaremos las ordenes o comandos a ejecutar a la tecnología Node.js.</p>
</div>
<div class="paragraph">
<p>Al igual con el ejemplo anterior en Java, en primer lugar trabajaremos con la aplicación Node.js sin <em>dockerizar</em>, y después <em>dockerizaremos</em> la aplicación. La mayoría de los pasos siempre los ejecutaremos primero en local, y tras comprobar que funcionan correctamente, los automatizaremos en Jenkins.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>La implementación de la integración y despliegue continuos permitirá que, para cada cambio de código en el repositorio, Jenkins será notificado y descargará los cambios, instalará las dependencias y ejecutará los tests. Si los tests pasan correctamente, Jenkins desplegará la aplicación en el servidor de despliegue. Y si fallan, se notificará al desarrollador.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_construcción_y_ejecución_en_local_2">10.1. Construcción y ejecución en local</h3>
<div class="paragraph">
<p>Nos vamos a basar en  el proyecto <em>HelloWorld</em> en NodeJs, disponible en <a href="https://github.com/ualcnsa/nodeapp" class="bare">https://github.com/ualcnsa/nodeapp</a>. Necesitarás poder hacer cambios sobre el mismo, así que crea un <em>fork</em> y trabaja con tu <em>fork</em> a partir de ahora.
Tras clonar tu <em>fork</em> a local, haz checkout del tag <code>v0.1</code> en una nueva rama cuyo nombre sea tu usuario de la UAL, para que tus archivos estén en el estado inicial de este tutorial:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git checkout tags/v0.1 -b &lt;branch&gt; <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usa tu nombre de usuario de la UAL como nombre de la rama.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Veamos los archivos que componen la aplicación:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>El archivo <code>package.json</code> contienen información básica de la aplicación y las dependencias:</p>
<div class="ulist">
<ul>
<li>
<p><strong>express</strong>: Node framework</p>
</li>
<li>
<p><strong>jest</strong>: framework de testing para NodeJs (existen numerosos framework de testing en NodeJs, como Jasmine, Mocha, Tape, etc.)</p>
</li>
<li>
<p><strong>supertest</strong>: proporciona abstracción a alto nivel para testing HTTP</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">package.json</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "name": "nodeapp",
  "version": "1.0.0",
  "description": "",
  "main": "src/main.js",
    "scripts": {
    "start": "node src/main",
    "test": "jest"
    },
  "author": "",
  "license": "ISC",
   "dependencies": {
    "express": "^4.17.3"
   },
   "devDependencies": {
    "jest": "^27.5.1",
    "supertest": "^6.2.2"
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Comprueba que los archivos <code>main.js</code>, <code>app.js</code> y  <code>app.test.js</code>, así como la carpeta <code>services</code>, estén dentro de una carpeta <code>src</code>. Si no es así, crea la carpeta <code>src</code> y muevelos dentro. Revisa el conetenido de <code>package.json</code> para que sea idéntico al mostrado aquí.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/node-files-initial-point.png" alt="node files initial point">
</div>
<div class="title">Fig. 77. Archivos y carpetas en el estado inicial</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para instalar las dependencias ejecuta <code>npm install</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>El archivo principal del proyecto <code>src/main.js</code> se encarga de arrancar la aplicación en el puerto 3000.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">src/main.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const app = require("./app");
const port = 3000
app.listen(port, () =&gt; {
  console.log(`Example app listening on port ${port}`)
})</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>El archivo <code>src/app.js</code> es un sencillo <em>hola mundo</em> con dos rutas:</p>
<div class="ulist">
<ul>
<li>
<p><code>/</code> devuelve <code>"Hello World!"</code></p>
</li>
<li>
<p><code>/:nameToSalute</code> devuelve <code>"Hello " + nameToSalute + "!"</code> mediante el servicio <code>HelloWordService</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">src/app.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const express = require('express')
const HelloWordService = require( "./services/hello-world" );

const app = express()

app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
})

app.get('/:nameToSalute', (req, res) =&gt; {
  res.send(new HelloWordService().greet(req.params.nameToSalute));
})

module.exports = app</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>El archivo <code>src/services/hello-world.js</code> es un servicio de <em>hola mundo</em>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">src/services/hello-world.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">class HelloWordService {
  /**
    * @description Create an instance of HelloWordService
    */
  constructor () {

  }

  /**
    * @description Says Hello to a given name
    * @param nameToHello {string} Name to greet
    * greet name
    * @returns a string that starts with Hello
    */
  greet ( nameToHello ) {

      return "Hello " + nameToHello+"!";

  }
}

module.exports = HelloWordService;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejecutar la aplicación, ejecuta: <code>npm start</code></p>
</div>
<div class="paragraph">
<p>Puedes ver la aplicación en el navegador accediendo a <a href="http://localhost:3000">http://localhost:3000</a> o a <a href="http://localhost:3000/nombre">http://localhost:3000/nombre</a></p>
</div>
<div class="paragraph">
<p><strong>Test unitarios y end2end</strong></p>
</div>
<div class="paragraph">
<p>En primer lugar tenemos un <strong>test unitario</strong> para probar el servicio <code>HelloWorldService</code> que comprueba que la salida sea la esperada.</p>
</div>
<div class="paragraph">
<p>Se guardará en la carpeta <code>src/services/</code> con el nombre <code>hello-world.test.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/services/hello-world.test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const HelloWordService = require("./hello-world");

describe("HelloWordService Test", () =&gt; {
  const helloWordService = new HelloWordService();

  it("says 'Hello John!' to greet John", () =&gt; {
    expect(helloWordService.greet("John")).toBe("Hello John!");
  });

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>En segundo lugar tenemos varios <strong>test end2end</strong>. El primer test va a navegar a la raiz de la aplicación (<code>/</code>) y verificar que la página responde con el texto esperado <code>Hello World!</code>. El segundo test navega a <code>/John</code> y comprueba que la página responde con <code>Hello John!</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/app.test.js</div>
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const request = require("supertest");

const app = require("./app");

describe("GET /", () =&gt; {
    //navigate to root and check the the response is "Hello World!"
    it('responds with "Hello World!"', (done) =&gt; {
        request(app).get('/').expect('Hello World!', done);
    });
});

describe("GET /John", () =&gt; {
    //navigate to /John and check the the response is "Hello John!"
    it('responds with "Hello John!"', (done) =&gt; {
        request(app).get('/John').expect('Hello John!', done);
    });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejecutar los tests: <code>npm test</code></p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/node-jest-passed.png" alt="node jest passed">
</div>
<div class="title">Fig. 78. npm test</div>
</div>
<div class="paragraph">
<p>Si todo funciona correctamenente, haz <strong>commit</strong> y <strong>push</strong> de tu rama.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creación_del_pipeline_en_jenkins">10.2. Creación del pipeline en Jenkins</h3>
<div class="paragraph">
<p>Definimos un nuevo proyecto tipo Pipeline. Añadimos la descripción del pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
  agent any

  tools {
    // In Global tools configuration, install Node configured as "nodejs"
    nodejs "nodejs"
  }

  stages {
    stage('Cloning Git') {
      steps {
        git branch: 'MI_RAMA', url: 'https://github.com/MI_USUARIO/nodeapp' <i class="conum" data-value="1"></i><b>(1)</b>
      }
    }

    stage('Install dependencies') {
      steps {
        sh 'npm install'
      }
    }

    stage('Test') {
      steps {
         sh 'npm test'
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cambia el nombre de la rama y la URL del repositorio por las tuyas.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El resultado sera:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-node-pipeline1.png" alt="jenkins node pipeline1">
</div>
<div class="title">Fig. 79. Nodeapp pipeline</div>
</div>
<div class="paragraph">
<p>La evolución de las métricas del proyecto es uno de los indicadores que habitualmente muestra Jenkins como <em>feedback</em> para los desarrolladores. Vamos a <strong>publicar los resultados de los test</strong> en un gráfico.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Editamos <code>package.json</code> y añadimos el script <code>test-jenkins</code> para generar los resultados de los test en formato xml que usará Jenkins para generar el gráfico, y la dependencia necesaria para ello:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">package.json: jenkins-test y dependencia mocha-junit-reporter</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">  ...
  "scripts": {
    "start": "node src/main",
    "test": "jest",
    "test-jenkins": "jest --reporters=default --reporters=jest-junit", <i class="conum" data-value="1"></i><b>(1)</b>
  },
  "jest-junit": { <i class="conum" data-value="2"></i><b>(2)</b>
    "outputDirectory": "./coverage/",
    "outputName": "test.results.xml",
    "usePathForSuiteName": "true"
  },
  ...
  "devDependencies": {
    "jest": "^27.5.1",
    "jest-junit": "^13.0.0", <i class="conum" data-value="3"></i><b>(3)</b>
    "supertest": "^6.2.2"
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos el script <code>test-jenkins</code> que define los formatos de salida de los test: el normal y usando el plugin <code>jest-junit</code> para formato xml.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuración para <code>jest-junit</code> que genera los resultados de los test en el archivo <code>./coverage/test.results.xml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Dependencia a <code>jest-junit</code> que permite generar los resultados de los test en xml.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Podemos probar en local, llamamos a la ejecución de los test y generación del xml: <code>npm run test-jenkins</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Añade al <code>.gitignore</code> la carpeta <code>/coverage</code>, ya que su contenido se generará al lanzar los tests y no se debe guardar en el repositorio.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Guarda los cambios en el repositorio, para que estén actualizados cuando los lea  Jenkins.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Actualizamos el pipeline, la fase <code>Test</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Test') {
      steps {
         sh 'npm run test-jenkins'
      }
      post {
        success {
          junit '**/test*.xml'
        }
      }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Guardamos los cambios. Tras un par de ejecuciones del build, se visualiza el gráfico Test Result Trend:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-nodeapp-pipeline-test-result-trend.png" alt="jenkins nodeapp pipeline test result trend">
</div>
<div class="title">Fig. 80. Publicado el gráfico de tendencia de los test</div>
</div>
</div>
<div class="sect2">
<h3 id="_webhook_para_construcción_automática">10.3. <strong>Webhook</strong> para construcción automática</h3>
<div class="paragraph">
<p>Configura en GitHub un nuevo <em>Webhook</em> para que tras cada cambio de código en el repositorio, Jenkins sea notificado y lance automáticamente la construcción del pipeline:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En GitHub, seleccionamos el repositorio sobre el que queremos activar la construcción en Jenkins y hacemos clic en: <em>Settings &gt; WebHooks &gt; Add webhook</em></p>
</li>
<li>
<p>En Payload URL:</p>
<div class="literalblock">
<div class="content">
<pre>http://{YOUR_JENKINS_URL}/github-webhook/</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-webhook-github.png" alt="jenkins webhook github">
</div>
<div class="title">Fig. 81. Nuevo Webhook</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Finalmente, en la configuración del proyecto en Jenkins, en la sección Build Trigers, marca la opción <em>GitHub hook tirigger from GITScm polling</em></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-webhook-build-triger.png" alt="jenkins webhook build triger">
</div>
<div class="title">Fig. 82. Activar el Webhook en build trigers</div>
</div>
<div class="paragraph">
<p>A partir de ahora, cuando el repositorio en GitHub reciba un push notificará a Jenkins para que lance la construcción automáticamente.</p>
</div>
</div>
<div class="sect2">
<h3 id="_informe_de_cobertura">10.4. Informe de cobertura</h3>
<div class="paragraph">
<p>Como ya sabemos, la cobertura de código nos va a ofrecer un valor directamente relacionado con la calidad de los juegos de prueba. Para obtener la cobertura y publicarla en Jenkins, debemos hacer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir a <code>package.json</code> un script para cobertura que permite obtener la cobertura con Jest.</p>
</li>
<li>
<p>Modificar la fase <em>Test</em> de Jenkins para que llame al script de cobertura y publique, en el bloque <code>post</code>, el informe de cobertura generado.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>1.Modifica <code>package.json</code>, añadiendo el nuevo script y la dependencia:</p>
</div>
<div class="listingblock">
<div class="title">package.json: cobertura</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">   ...
   "scripts": {
      ...
      "coverage-jenkins": "jest --reporters=default --reporters=jest-junit --coverage --coverageReporters=text --coverageReporters=html --coverageDirectory=./coverage/"
   },
   ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos probar en local, llamamos a la ejecución del script: <code>npm run coverage-jenkins</code>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/node-jest-coverage-jenkins-ok.png" alt="node jest coverage jenkins ok">
</div>
<div class="title">Fig. 83. Ejecución de cobertura</div>
</div>
<div class="paragraph">
<p>Como resultado, en la carpeta <code>coverage</code> del proyecto se ha generado el informe de cobertura.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/node-mocha-coverage-results.png" alt="node mocha coverage results" width="160">
</div>
<div class="title">Fig. 84. Informe de cobertura</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/node-jest-coverage-index.png" alt="node jest coverage index">
</div>
<div class="title">Fig. 85. Informe de cobertura en html</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Modifica el pipeline de Jenkins, la fase <code>Test</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Test') {
      steps {
         sh 'npm run coverage-jenkins' <i class="conum" data-value="1"></i><b>(1)</b>
      }
      post {
        success {
          junit '**/test*.xml'
          publishHTML target: [ <i class="conum" data-value="2"></i><b>(2)</b>
            allowMissing          : false,
            alwaysLinkToLastBuild : false,
            keepAll               : true,
            reportDir             : './coverage/',
            reportFiles           : 'index.html',
            reportName            : 'Coverage Report'
          ]
        }
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Llama al nuevo script que calcula la cobertura</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Publica el informe de cobertura</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Instala el HTML Publisher plugin en Jenkins</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El resultado en Jenkins, debe aparece un enlace nuevo en el menú de la izquierda:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-node-coverage-report-link.png" alt="jenkins node coverage report link">
</div>
<div class="title">Fig. 86. Enlace al informe de cobertura en html</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Para poder visualizar correctamente el <em>Coverage Report</em>, hay que cambiar la <a href="https://wiki.jenkins.io/display/JENKINS/Configuring+Content+Security+Policy#ConfiguringContentSecurityPolicy-TheDefaultRuleSet">configuración de seguridad</a> de Jenkins predeterminada, que es muy restrictiva para prevenir de archivos HTML/JS maliciosos que podrían instalarse como parte de un Plugin. Para modificar la configuración, abre la consola de scritps (<em>Manage Jenkins / Script Console</em>), y ejecuta estas líneas:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">System.setProperty("hudson.model.DirectoryBrowserSupport.CSP", "sandbox; default-src 'none'; img-src 'self'; style-src 'self' 'unsafe-inline'; ")
System.getProperty("hudson.model.DirectoryBrowserSupport.CSP")</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/maven-script-console-site.png" alt="maven script console site">
</div>
<div class="title">Fig. 87. Script Console: permisos para visualizar el informe de cobertura</div>
</div>
<div class="paragraph">
<p>Tras ello ya podrás visualizar correctamente el informe de cobertura. Pero ten en cuenta que cada vez que reinicies Jenkins esta configuración  se pierde y vuelve a la configuración predeterminada.</p>
</div>
</div>
<div class="sect2">
<h3 id="_análisis_estático_de_código">10.5. Análisis estático de código</h3>
<div class="paragraph">
<p>El código JavaScript es dinámicamente tipado, por lo que en lugar de usar el compilador para realizar el análisis estático de código, como ocurre en lenguajes como Java, las formas más comunes de <a href="https://medium.com/codecademy-engineering/static-analysis-in-javascript-a-technical-introduction-859de5d444a6">análisis estático en JavaScript</a> son <em>formatters</em> y <em>linters</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Formatters</em> o formateadores, escanean y reformatean rápidamente los archivos de código. Uno de los más populares es <a href="https://prettier.io/">Prettier</a>, que como cualquier buen formateador, corregirá automaticamente las inconsistencias que encuentre.</p>
</li>
<li>
<p><em>Linters</em> pueden trabajar en aspectos de formato pero también otros problemas más complejos. Se basan en una serie de reglas para escanear el código, o descripciones de comportamientos a vigilar, y muestran todas las violaciones que encuentran. El más popular para JavaScript es <a href="https://eslint.org/">ESLint</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a probar <strong>ESLint</strong>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instala con npm:</p>
<div class="literalblock">
<div class="content">
<pre>npm install eslint eslint-config-prettier eslint-plugin-prettier --save-dev</pre>
</div>
</div>
</li>
<li>
<p>A continuación, inicializa un archivo de configuración:</p>
<div class="literalblock">
<div class="content">
<pre>npx eslint --init</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Y responde a las preguntas:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/eslint-init.png" alt="eslint init">
</div>
<div class="title">Fig. 88. ESLint init</div>
</div>
<div class="paragraph">
<p>Se habrá creado un archivo <code>.eslintrc.json</code>, que incluirá esta línea:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "extends": "eslint:recommended" <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Habilita las <a href="https://eslint.org/docs/rules/">reglas predeterminadas</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En lugar del anterior fichero, puedes utilizar un fichero <code>.eslintrc.js</code> como el siguiente, que contiene recomendaciones para express:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">module.exports = {
    env: {
        es6: true,
        node: true
    },
    extends: ['prettier'],
    plugins: ['prettier'],
    globals: {
        Atomics: 'readonly',
        SharedArrayBuffer: 'readonly'
    },
    parserOptions: {
        ecmaVersion: 2018,
        sourceType: 'module'
    },
    rules: {
        'prettier/prettier': 'error',
        'class-methods-use-this': 'off',
        'no-param-reassign': 'off',
        camelcase: 'off',
        'no-unused-vars': ['error', { argsIgnorePattern: 'next' }]
    }
};</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Añade a <code>package.json</code> un script para <code>lint</code> y la dependencia a ESLint</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">package.json: lint y dependencia a ESLint</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">   "scripts": {
      ...
      "lint": "eslint src/**/*.js -f checkstyle -o coverage/eslint-result.xml"
   },
   ...
   "devDependencies": {
      ...
      "eslint": "^8.10.0",
      "eslint-config-prettier": "^8.5.0",
      "eslint-plugin-prettier": "^4.0.0",
      "prettier": "^2.5.1",
   }
   ...</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Lánzalo en local:</p>
<div class="literalblock">
<div class="content">
<pre>npm run lint -s</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>El parámetro <code>-s</code> se utiliza para que no muestre mensajes de error. Habrá generado el archivo <code>coverage/eslint-result.xml</code> en formato similar al informe de <em>CheckStyle</em> para poder importarlo correctamente en Jenkins.</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>En Jenkins, añade una nueva fase <code>Analysis</code> en el pipeline, en la que llames a <code>lint</code> y publiques el informe generado por <strong>ESLint</strong> con el formato <em>CheckStyle</em>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">   stage('Analysis'){
      steps{
          sh 'npm run lint -s'
      }
      post {
         always{
            // record lint issues found, also, fail the build if there are ANY NEW issues found
            recordIssues enabledForFailure: true,
                blameDisabled: true,
                tools: [esLint(pattern: '**/eslint-result.xml')],
                qualityGates: [[threshold: 1, type: 'NEW']]
        }
      }
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>El enlace al informe de ESLint no aparece en la página principal del proyecto, en el menú de enlaces, sino que tienes que hacer clic en el número del último build, y en la nueva página ya aparece el enlace:</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/eslint-jenkins-link.png" alt="eslint jenkins link">
</div>
<div class="title">Fig. 89. Enlace al informe <em>ESLint</em></div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>No te preocupes si la fase de análisis que acabas de añadir falla (está en rojo). Es así porque cuando ESLint detecta un error, finaliza con error (<code>EXIT 1</code>). Si te fijas en el informe, los 2 errores detectados han sido en el archivo <code>test.js</code> (y pueden ser falsos positivos). Para evitarlo, elimina <code>test/*.js</code> del script <code>lint</code> en <code>package.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tras ello, la nueva ejecución del pipeline se ejecutará correctamente.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/eslint-jenkins-pass-grapth.png" alt="eslint jenkins pass grapth">
</div>
<div class="title">Fig. 90. Fase <em>ESLint</em> <em>passed</em></div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_la_vm_2">10.6. Despliegue en la VM</h3>
<div class="paragraph">
<p>Para desplegar la aplicación <em>hello world</em> en la instancia de despliegue vamos a clonar el repositorio y a continuación ejecutaremos en ella la orden de Node para ponerla en marcha.</p>
</div>
<div class="paragraph">
<p>Recuerda que ya he hemos realizado una configuración previa sobre la instancia de despliegue, que constituyen los  <strong>prerrequisitos</strong> para esta sección:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Con anterioridad ya instalamos NodeJS en la instancia de despliegue.</p>
</li>
<li>
<p>También habíamos copiado la clave pública de despliegue para que Jenkins, que tiene la clave privada asociada, pueda hacer <code>ssh</code> y ejecutar comandos sobre ella.</p>
</li>
<li>
<p>Como requisito adicional, para ayudarnos a lanzar <code>npm start</code> desde Jenkins, como un proceso demonio en background, usaremos <a href="https://www.npmjs.com/package/forever"><strong>forever</strong></a>. Debes instalar <code>forever</code> en la  instancia de despliegue:</p>
<div class="literalblock">
<div class="content">
<pre>sudo npm install forever -g</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una vez revisados los prerrequisitos, añade la fase de despliegue al pipeline en Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copia este nueva fase en tu pipeline, sustituyendo DEPLOY_MACHINE por el nombre DNS de tu instancia, y usa el nombre del repositorio git adecuado:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">  stage('Deploy'){
    steps {
      sh '''
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "if [ ! -d 'nodeapp' ] ; then
          git clone https://github.com/ualcnsa/nodeapp.git
        else
          cd nodeapp
          git pull origin master
        fi" <i class="conum" data-value="1"></i><b>(1)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "if pgrep node; then forever stopall; fi" <i class="conum" data-value="2"></i><b>(2)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "cd nodeapp &amp;&amp; npm install" <i class="conum" data-value="3"></i><b>(3)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "cd nodeapp &amp;&amp; PORT=8080 forever start index.js" <i class="conum" data-value="4"></i><b>(4)</b>
      '''
    }
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Clona el repositorio si no existe en la máquina de despliegue, si existe hace un <code>pull</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Detiene la ejecución de <code>forever</code> si existe de un despliegue anterior, usando <code>forever stop</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instala las dependencias</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ejecuta la aplicación con <code>forever start</code> en el puerto <code>8080</code>, que ejecuta el proceso en background como demonio.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://codelabs.developers.google.com/codelabs/cloud-create-a-nodejs-vm/">Running Node.js on a Virtual Machine codelab</a></p>
</li>
<li>
<p><a href="https://medium.com/@mosheezderman/how-to-set-up-ci-cd-pipeline-for-a-node-js-app-with-jenkins-c51581cc783c">How to set up CI/CD Pipeline for a node.js app with Jenkins</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hola_mundo_en_node_js_con_docker">11. <em>Hola mundo</em> en Node.js con Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para realizar el despliegue de la app <em>Hola mundo</em> en Node.js como un contenedor, primero tenemos que <a href="https://nodejs.org/fr/docs/guides/nodejs-docker-webapp/">dockerizar</a> la aplicación. Una vez construido el contenedor, habrá que publicar la imagen de contenedor en un registro como Google Container Registry, y por último ejecutar el contenedor en la instancia de despliegue.</p>
</div>
<div class="paragraph">
<p>A continuación se describe cómo crear un contenedor Docker de la aplicación Node.js. Los pasos se realizan en local, y al final configuraremos el pipeline de Jenkins para que se realicen automáticamente.</p>
</div>
<div class="sect2">
<h3 id="_creación_del_dockerfile">11.1. Creación del <code>Dockerfile</code></h3>
<div class="paragraph">
<p>Para crear el contendedor de Docker que empaquete la aplicación Node.js, vamos a definir el siguiente archivo <code>Dockerfile</code> que debe estar en la carpeta raíz del proyecto:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM node:10-alpine

# Create app directory
WORKDIR /usr/src/app

# Install app dependencies
# A wildcard is used to ensure both package.json AND package-lock.json are copied
# where available (npm@5+)
COPY package*.json ./

RUN npm install
# If you are building your code for production
# RUN npm ci --only=production

# Bundle app source
COPY . .

EXPOSE 3000
CMD [ "npm", "start" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>El Dockerfile es muy sencillo, contiene los <a href="https://nodejs.org/fr/docs/guides/nodejs-docker-webapp/#creating-a-dockerfile">pasos básicos</a> para ejecutar una aplicación en un contenedor.</p>
</div>
<div class="paragraph">
<p>Crea además un archivo <code>.dockerignore</code> en la misma carpeta que tu Dockerfile con el siguiente contenido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>node_modules/
.git/
.gitignore
npm-debug.log</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Puedes construir la imagen del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker build -t &lt;your username&gt;/nodeapp .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras ello, ejecuta: <code>docker images</code>. La imagen debe aparecer en la lista de imágenes de Docker en tu equipo:</p>
</div>
<div class="paragraph">
<p>Prueba la ejecución del contenedor en local:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -p 3000:3000 -d --name hello-node &lt;your username&gt;/nodeapp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprueba que se ha iniciado la aplicación en <a href="http://localhost:3000" class="bare">http://localhost:3000</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Comprueba que el contenedor está ejecutándose con <code>docker ps</code></p>
</li>
<li>
<p>Detén el contenedor con <code>docker stop &lt;ID&gt;</code></p>
</li>
<li>
<p>Comprueba que ya no está ejecutándose, pero el contenedor sigue existiendo, lo puedes ver con <code>docker ps -a</code></p>
</li>
<li>
<p>Podrías volver a arrancarlo con <code>docker start &lt;ID&gt;</code>, pero en su lugar, elimina el contenedor con <code>docker rm &lt;ID&gt;</code></p>
</li>
<li>
<p>La imagen sigue existiendo, puedes verlo con <code>docker images</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_publicación_de_la_imagen_en_el_registro">11.2. Publicación de la imagen en el registro</h3>
<div class="paragraph">
<p>Una vez creada la imagen con <code>docker build</code> y probada su ejecución con <code>docker run</code>, el siguiente paso será publicar la imagen en un registro de contenedores, mediante <code>docker push</code>. De nuevo vamos a usar Google Cloud <a href="https://cloud.google.com/container-registry?hl=es">Container Registry</a>.</p>
</div>
<div class="paragraph">
<p>Para poder hacer <code>push</code> debemos tener permisos de escritura, y por tanto debemos autenticarnos en el servicio Container Registry. Este proceso ya se hizo en la para el ejemplo de Java en la sección <em>Autenticación en Container Registry</em>. Ahora, simplemente comprueba que mantienes el login del Container Registry.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Comprueba el login al registro:</p>
<div class="literalblock">
<div class="content">
<pre>docker login https://gcr.io</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/docker-login-done.png" alt="docker login done">
</div>
<div class="title">Fig. 91. Comprobar docker login</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si <code>docker login</code> te da error, revisa los pasos de la sección anterior de <em>Autenticación en Container Registry</em>. No es necesario que vuelvas a generar el archivo de credenciales, simplemente copia ese archivo .json en el proyecto actual y úsalo para hacer login.</p>
</div>
<div class="paragraph">
<p>En tal caso, no olvides añadir el archivo de credenciales al <code>.gitignore</code> para evitar publicar en GitHub tus credenciales.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Etiqueta el contenedor con el nombre completo incluyendo la referencia a Container registry (gcr.io). Primero definimos una variable de entorno con el nombre de nuestro proyecto GCP, y luego etiquetamos la imagen ya construida con un nuevo nombre completo del registro de contenedores:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">GOOGLE_CLOUD_PROJECT=cnsa-2022-user123

docker tag  &lt;your username&gt;/nodeapp gcr.io/$GOOGLE_CLOUD_PROJECT/nodeapp:1.0</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Comprueba que se ha etiquetado correctamente</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/docker-tag-nodeapp.png" alt="docker tag nodeapp">
</div>
<div class="title">Fig. 92. Imagen etiquetada</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>A continuación, publica la imagen en el registro con <code>docker push</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker push gcr.io/$GOOGLE_CLOUD_PROJECT/nodeapp:1.0</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Comprueba que se ha publicado correctamente.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/container-registry-pushed-nodeapp.png" alt="container registry pushed nodeapp">
</div>
<div class="title">Fig. 93. Lista de imágenes en Container Registry</div>
</div>
<div class="paragraph">
<p>La imagen del contenedor <strong>nodeapp</strong> ya está disponible en el registro privado de nuestro proyecto GCP. Utilizando nuestras credenciales podremos hacer <code>docker pull</code> de dicha imagen para descargarla en cualquier máquina con docker, y ejecutarlo con <code>docker run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -p 3000:3000 -t --name nodeapp gcr.io/$GOOGLE_CLOUD_PROJECT/nodeapp:1.0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_vm">11.3. Despliegue en VM</h3>
<div class="paragraph">
<p>Conecta a la instancia de despliegue para ejecutar el contenedor. Antes vamos a comprobar el login al registro. En la máquina de despliegue ya habíamos copiado el archivo de credenciales <code>.json</code> con premisos sobre Container Registry. A continuación se recuerdan los comandos necesarios para ello.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Conectamos a la máquina de despliegue
ssh ubuntu@DNS_MAQUINA_DEPLOY
# Autenticamos docker contra Container Registry
cat keyfile.json | docker login -u _json_key --password-stdin https://gcr.io
# ejecutamos el contenedor desde gcr.io
docker run -p 8080:3000 -t --name nodeapp gcr.io/$GOOGLE_CLOUD_PROJECT/nodeapp:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hemos publicado el contenedor en el puerto 8080 ya que es el que está abierto en las reglas del firewall de nuestro proyecto GCP.</p>
</div>
<div class="paragraph">
<p>Es posible que la ejecución del contenedor de un error, porque el puerto 8080 ya esté en uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Error starting userland proxy: listen tcp 0.0.0.0:8080: bind: address already in use.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionarlo, bien detén el proceso o contenedor java que está corriendo con la aplicación PetClinic del ejemplo anterior. O bien utiliza el puerto 80 que también está abierto.</p>
</div>
</div>
<div class="sect2">
<h3 id="_integración_y_despliegue_continuos_con_jenkins">11.4. Integración y despliegue continuos con Jenkins</h3>
<div class="paragraph">
<p>A continuación, vamos a automatizar en Jenkins todo el proceso:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la construcción de la imagen del contenedor,</p>
</li>
<li>
<p>la publicación de la imagen en el registro, y</p>
</li>
<li>
<p>el despliegue del contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los plugins de  Jenkins necesarios ya los tenemos configurados el ejemplo en Java.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Definimos un nuevo proyecto en Jenkins de tipo pipeline, con el nombre <code><code>nodeapp-Docker-abc123</code></code> sustituyendo abc123 por nuestro nombre de usuario. Son necesarios 3 fases (stages) en el pipeline: <em>build image</em>, <em>push image</em>, y <em>deploy container</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Comenzamos por la <strong>construcción de la imagen</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">pipeline {
  agent any
  environment {
    CONTAINER_REGISTRY = 'gcr.io'
    GOOGLE_CLOUD_PROJECT = 'cnsa-2022'
    CREDENTIALS_ID = 'cnsa-2022-gcr'
  }

  tools {
    // In Global tools configuration, install Node configured as "nodejs"
    nodejs "nodejs"
  }

  stages {

    stage("Git Checkout") {
      steps {
        // checkout scm
        git 'https://github.com/ualcnsa/nodeapp.git'
      }
    }

    stage('Install dependencies') {
      steps {
        sh 'npm install'
      }
    }
    stage('Test') {
      steps {
         sh 'npm run test-jenkins'
      }
      post {
        success {
          junit '**/test*.xml'
        }
      }
    }

    stage("Build image") {
      steps {
        script {
          dockerImage = docker.build(
            "${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/nodeapp:${env.BUILD_ID}",
            "-f Dockerfile ."
          )
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para probar que la imagen del contenedor se ha creado bien, añade la siguiente fase que hace un despliegue "local" en la propia máquina de Jenkins, es decir, ejecuta un contenedor basado en la imagen que acabamos de crear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage("Run image locally") {
      steps {
        sh "docker stop nodeapp || true &amp;&amp; docker rm  nodeapp || true" <i class="conum" data-value="1"></i><b>(1)</b>
        sh "docker run -d -p 8080:3000 -t --name nodeapp ${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/nodeapp:${env.BUILD_ID}" <i class="conum" data-value="2"></i><b>(2)</b>
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Por si ya se ha ejecutado el pipeline anteriormente, es necesario comprobar si el contenedor <code>nodeapp</code> ya se está ejecutando, y en tal caso pararlo con <code>docker stop</code> y eliminarlo con <code>docker rm</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Con <code>docker run</code> ejecuta el contenedor <code>nodeapp</code> a partir de la imagen recién construida. Para que el pipeline pueda finalizar y el contenedor siga ejecutándose, se añade <code>-d</code> que indica modo <em>detached</em> que ejecuta el contenedor en background.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras ello, la aplicación debe estar accesible en el puerto 8080 en tu máquina de Jenkins. Para asegurarnos que la aplicación se está ejecutando bien, debemos problarlo "manualmente". Para automatizar esta prueba, lo adecuado sería realizar unos tests end-to-end, con <a href="https://www.selenium.dev">Selenium</a>. Esto se explicará en otra actividad, dedicada al testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('End-to-end Test image') {
        // Ideally, we would run some end-to-end tests against our running container.
        steps{
            sh 'echo "End-to-end Tests passed"'
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>El siguiente paso es <strong>publicar la imagen</strong> en el registro.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primero, las credenciales en Jenkins para poder hacer <code>push</code> en Container Registry ya están creadas del ejemplo anterior (Si tienes algún problema, consulta la sección correspondiente del ejemplo de Java)</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Define la fase para publicar la imagen del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage("Push image") {
        steps {
            script {
                docker.withRegistry('https://'+ CONTAINER_REGISTRY, 'gcr:'+ GOOGLE_CLOUD_PROJECT) {
                        dockerImage.push("latest")
                        dockerImage.push("${env.BUILD_ID}")
                }
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprueba que se ha publicado correctamente en el registro.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-published-nodeapp-container-registry.png" alt="jenkins published nodeapp container registry">
</div>
<div class="title">Fig. 94. Imagen publicada en Container Registry, etiquetada con el número de build</div>
</div>
<div class="paragraph">
<p>Por último, quedaría el paso de <strong>desplegar al entorno de producción</strong>: la máquina virtual de despliegue.</p>
</div>
<div class="paragraph">
<p>Los pasos para el despliegue de la nueva imagen del contenedor consistirán en ejecutar los siguientes comandos sobre la máquina de despliegue:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker stop</code> del contenedor por si estuviera ejecutándose</p>
</li>
<li>
<p><code>docker rm</code> para eliminar el contenedor existente, que puede estar basado en una imagen de una versión anterior</p>
</li>
<li>
<p><code>docker run</code> que primero hará un <code>docker pull</code> de la imagen actualizada del registro. Lo lanzaremos en el puerto 80 ya que el 8080 está ocupado por el despliegue que hicimos sin contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas acciones debemos añadirlas a un <code>stage</code> del pipeline de Jenkins que se encargará de desplegar el nuevo contenedor automáticamente. En el siguiente código, sustituye <code>DNS_DEPLOY_INSTANCE</code> por el nombre DNS de tu instancia de despliegue. También puedes definirla como una variable de entorno al inicio del pipeline.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Deploy to Production') {
      steps{
        sh '''
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "if docker ps -q --filter name=nodeapp | grep . ; then docker stop nodeapp ; fi" <i class="conum" data-value="1"></i><b>(1)</b>
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "if docker ps -a -q --filter name=nodeapp | grep . ; then docker rm -fv nodeapp ; fi" <i class="conum" data-value="1"></i><b>(1)</b>
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@DNS_DEPLOY_INSTANCE "docker run -d -p 8080:3000 -t --name nodeapp ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/nodeapp:latest" <i class="conum" data-value="2"></i><b>(2)</b>
        '''
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejecuta en la instancia de despliegue el comando que detiene y elimina el contenedor <code>nodeapp</code> en caso de que ya se estuviera ejecutando</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ejecuta en la instancia de despliegue el comando para ejecutar el contenedor basado en la última versión de la imagen, lanzándolo en background y con <code>-d</code> para que el pipeline finalice y el contenedor permanezca en ejecución.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La aplicación nodeapp debe estar accesible <em>en producción</em>, en el puerto 8080 en la instancia de despliegue. Para asegurarnos, debemos problarlo "manualmente". Para automatizar esta prueba <em>en producción</em>, lo adecuado de nuevo sería realizar unos tests end-to-end, con <a href="https://www.selenium.dev">Selenium</a>. Esto se explicará en otra actividad, dedicada al testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('End-to-end Test on Production') {
        // Ideally, we would run some end-to-end tests against our running container.
        steps{
            sh 'echo "End-to-end Tests passed on Production"'
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por último, es una buena práctica eliminar las imágenes que se van generando en cada build, para liberar espacio en la máquina de Jenkins. Primero paramos y eliminamos el contenedor local, luego eliminamos la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">    stage('Remove Unused docker image') {
      steps{
        // input message:"Proceed with removing image locally?" <i class="conum" data-value="1"></i><b>(1)</b>
        sh 'if docker ps -q --filter name=nodeapp | grep . ; then docker stop nodeapp &amp;&amp; docker rm -fv nodeapp; fi' <i class="conum" data-value="2"></i><b>(2)</b>
        sh 'docker rmi ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/nodeapp:$BUILD_NUMBER' <i class="conum" data-value="3"></i><b>(3)</b>
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pide confirmación al usuario, que tendrán que pulsar un botón de <em>Proceed</em> para continuar la ejecución del pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Para y elimina el contenedor <em>local</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Elimina la imagen de contenedor en <em>local</em> con <code>docker rmi</code> para liberar espacio.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El pipeline completo, con todas sus fases, debe quedar así:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="modules/node-app/images/jenkins-nodeapp-full-pipeline.png" alt="jenkins nodeapp full pipeline">
</div>
<div class="title">Fig. 95. Pipeline completo</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://nodejs.org/es/docs/guides/nodejs-docker-webapp/">Dockerizing a Node.js web app</a> @ Node.js Docs</p>
</li>
<li>
<p><a href="https://medium.com/@sssanjaya/a-simple-docker-setup-for-simple-hello-world-nodejs-application-bcf79bb608a0">A simple docker setup for hello world nodejs application</a> @ Medium</p>
</li>
<li>
<p><a href="https://semaphoreci.com/community/tutorials/dockerizing-a-node-js-web-application">Dockerizing a Node.js Web Application</a> @ SemaphoreCI</p>
</li>
<li>
<p><a href="https://www.docker.com/blog/keep-nodejs-rockin-in-docker/">Top 4 Tactics To Keep Node.js Rockin’ in Docker</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-13 13:55:27 +0100
</div>
</div>
</body>
</html>